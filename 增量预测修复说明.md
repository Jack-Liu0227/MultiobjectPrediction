# 增量预测功能修复说明

## 问题诊断

您遇到的问题包括：

1. **增量预测创建了新任务文件** (`946190c8-f633-4ac0-becf-4eddc34466e7.json`)，而不是在原任务 (`9ed64b7f-4eae-4f9a-a954-c68f028128ae`) 基础上继续
2. **第三轮迭代内容为空** (`storage\results\9ed64b7f-4eae-4f9a-a954-c68f028128ae\outputs\sample_3\iteration_3.txt`)，应该接着第二轮继续运行
3. **增量预测没有起作用**

## 根本原因

### 1. 配置对象类型错误
在 `_node_initialize` 方法中，代码错误地将 `PredictionConfig` 对象当作字典来访问：

```python
# ❌ 错误的代码
continue_from_task_id = config.get("continue_from_task_id")
```

应该使用对象属性访问：

```python
# ✅ 正确的代码
continue_from_task_id = config.continue_from_task_id
```

这导致增量预测标志从未被正确识别，系统每次都从头开始运行。

### 2. 前端直接调用 API 而不是跳转配置页面
之前的"增量预测"按钮直接调用 API，没有给用户修改配置的机会（例如增加迭代次数）。

## 修复内容

### 后端修复

#### 1. `backend/services/iterative_prediction_service.py`

**修复点1：`_node_initialize` 方法**
- 修复 `continue_from_task_id` 的访问方式
- 当检测到增量预测模式时，会：
  - 加载已有的 `iteration_history.json`
  - 恢复所有已收敛样本的状态
  - 重置失败样本，允许重试
  - 重置当前迭代轮次为 1，从头扫描并补全缺失的预测

**修复点2：`run_task` 方法**
- 添加增量预测模式检测
- 在日志中明确标记增量预测模式
- 正确传递 `continue_from_task_id` 到 `run_iterative_prediction`

#### 2. `backend/api/tasks.py`

**修复点1：`incremental_predict_task` 端点**
- 添加详细的日志记录
- 支持接收可选的配置更新（允许修改迭代次数等参数）
- **关键**：直接在原任务上运行，不创建新任务

```python
# 重置任务状态为运行中（在原任务上操作）
task_manager.update_task_status(
    task_id=task_id,  # 使用原任务ID
    status=TaskStatus.RUNNING,
    progress=0.0,
    message="开始增量预测..."
)
```

**修复点2：配置更新支持**
- 添加 `IncrementalPredictRequest` 模型
- 允许前端在增量预测时更新配置（如增加 `max_iterations`）
- 合并新配置和原配置

### 前端修复

#### 1. `frontend/pages/results/[id].tsx`

**修复：`handleIncrementalPredict` 方法**
- 从直接调用 API 改为跳转到配置页面
- 传递 `incremental_task_id` 参数

```typescript
// 跳转到预测配置页面，传递 incremental_task_id 参数
router.push(`/prediction?incremental_task_id=${id}`);
```

#### 2. `frontend/pages/prediction.tsx`

**修复点1：增量预测模式支持**
- 添加 `incrementalTaskId` 状态
- 检测 URL 中的 `incremental_task_id` 参数
- 加载原任务配置到页面

**修复点2：`handleStartPrediction` 方法**
- 检测增量预测模式
- 调用 `/api/tasks/{task_id}/incremental-predict` 端点
- 将配置更新发送给后端

```typescript
if (incrementalTaskId) {
  const requestBody = {
    config: {
      max_iterations: settings.maxIterations,  // 用户可以修改
      sample_size: settings.sampleSize,
      workers: settings.workers,
      // ... 其他配置
    }
  };

  await fetch(`http://localhost:8000/api/tasks/${incrementalTaskId}/incremental-predict`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestBody),
  });
}
```

## 新的增量预测流程

1. **用户在结果页点击"增量预测"**
2. **跳转到预测配置页面**
   - 自动加载原任务的配置
   - 用户可以修改参数（例如将 `max_iterations` 从 5 增加到 10）
3. **用户点击"开始增量预测"**
4. **后端处理**
   - 接收配置更新
   - 在**原任务**上运行（不创建新任务）
   - 加载 `iteration_history.json`
   - 恢复已收敛样本的状态
   - 只对未收敛或失败的样本继续预测
5. **结果保存**
   - 在原任务的目录下追加新的预测结果
   - 已有的 `iteration_1.txt`, `iteration_2.txt` 保持不变
   - 新增 `iteration_3.txt`, `iteration_4.txt` 等

## 测试建议

1. **验证增量预测不创建新任务**
   - 在结果页点击"增量预测"
   - 检查 `storage/tasks/` 目录，不应该有新的 JSON 文件生成

2. **验证迭代历史被正确加载**
   - 检查 `storage/results/{task_id}/iteration_history.json`
   - 确认已收敛样本的状态被正确恢复

3. **验证能够修改迭代次数**
   - 增量预测时将 `max_iterations` 从 5 改为 10
   - 确认系统会继续运行第 6-10 轮

4. **验证第三轮内容不为空**
   - 检查 `storage/results/{task_id}/outputs/sample_3/iteration_3.txt`
   - 应该包含 LLM 的预测响应

## 注意事项

- **数据集划分一致性**：增量预测时必须使用相同的 `random_seed`，以确保训练集和测试集划分一致
- **文件覆盖**：增量预测会追加新的迭代结果，不会覆盖已有的迭代文件
- **失败样本重试**：增量预测会自动重试之前失败的样本

## 下一步

如果您仍然遇到问题，请：

1. 删除 `storage/tasks/946190c8-f633-4ac0-becf-4eddc34466e7.json` 文件（这是错误创建的）
2. 删除 `storage/results/946190c8-f633-4ac0-becf-4eddc34466e7/` 目录
3. 重启服务 (`./start_all.sh`)
4. 再次尝试增量预测，这次应该会正确地在原任务上继续运行
