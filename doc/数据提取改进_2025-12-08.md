# 数据提取逻辑改进报告

**日期**: 2025-12-08  
**版本**: v1.1  
**改进模块**: `backend/services/simple_rag_engine.py`

## 问题描述

在预测结果中发现大量样本的预测值被错误地标记为 `0.0`，经分析发现是数据提取逻辑存在缺陷。

### 问题样本统计
- **总样本数**: 136
- **提取失败样本**: 134 (98.5%)
- **提取成功样本**: 2 (1.5%)

### 根本原因

1. **贪婪匹配问题**
   - 原始正则表达式 `r'\{.*\}'` 使用贪婪匹配
   - 当文本中存在多个JSON对象时，会匹配从第一个 `{` 到最后一个 `}` 的所有内容
   - 导致解析出错误的JSON结构

2. **JSON位置假设错误**
   - 原始代码假设JSON总是在文本开头
   - 实际LLM响应中，JSON可能出现在:
     - 文本开头 (如 sample_105)
     - markdown代码块中 (如 sample_9)
     - 文本末尾 (如 sample_36)

3. **缺少多种格式支持**
   - 未处理markdown代码块包裹的JSON
   - 未处理嵌套JSON结构
   - 未处理JSON前后有大量文本的情况

## 改进方案

### 新的提取策略

采用**多策略级联提取**方法:

#### 策略1: Markdown代码块提取
```python
json_code_block_pattern = r'```(?:json)?\s*(\{.*?\})\s*```'
json_code_matches = re.findall(json_code_block_pattern, text, re.DOTALL)
```
- 优先提取markdown代码块中的JSON
- 支持 ` ```json` 和 ` ``` ` 两种格式

#### 策略2: 非贪婪JSON匹配
```python
json_pattern = r'\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}'
json_matches = re.findall(json_pattern, text, re.DOTALL)
```
- 使用非贪婪匹配
- 支持嵌套JSON结构
- 查找所有可能的JSON对象

#### 策略3: 文本模式提取
```python
patterns = [
    rf'"{re.escape(target_col)}":\s*\{{\s*"value":\s*(\d+\.?\d*)',  # "UTS(MPa)": {"value": 1000.0
    rf'"{re.escape(target_col)}":\s*(\d+\.?\d*)',                   # "UTS(MPa)": 1000.0
    rf'{re.escape(target_col)}[:\s]+(\d+\.?\d*)',                   # UTS(MPa): 1000.0
]
```
- 当JSON解析失败时，直接从文本中提取数字
- 支持多种文本格式

### 改进后的处理流程

```
1. 提取所有候选JSON (代码块 + 普通JSON)
   ↓
2. 遍历每个候选JSON
   ↓
3. 尝试解析并提取 predictions 字段
   ↓
4. 如果成功提取所有目标，立即返回
   ↓
5. 如果JSON解析失败，使用文本模式提取
   ↓
6. 对缺失的目标使用默认值 0.0
```

## 测试结果

### 单元测试
```
测试 1: sample_9 - JSON在代码块中     ✓ 通过
测试 2: sample_36 - JSON在文本末尾    ✓ 通过
测试 3: sample_105 - JSON在开头       ✓ 通过
```

### 实际样本测试
```
文件: sample_9_b99834bc.txt
提取结果: {'UTS(MPa)': 673.7, 'El(%)': 31.3}  ✓ 成功

文件: sample_36_b99834bc.txt
提取结果: {'UTS(MPa)': 647.0, 'El(%)': 25.0}  ✓ 成功

文件: sample_105_b99834bc.txt
提取结果: {'UTS(MPa)': 2140.0, 'El(%)': 41.5}  ✓ 成功
```

## 改进效果

### 预期改进
- **提取成功率**: 从 1.5% 提升到 95%+
- **数据准确性**: 消除大量错误的 0.0 值
- **鲁棒性**: 支持多种LLM响应格式

### 日志增强
- 添加详细的调试日志
- 记录提取失败时的响应内容(前500和后500字符)
- 便于后续问题诊断

## 后续建议

1. **重新运行失败的预测任务**
   - 使用改进后的提取逻辑重新处理历史数据
   - 更新 predictions.csv 中的错误值

2. **监控提取成功率**
   - 添加提取成功率统计
   - 定期检查是否有新的提取失败模式

3. **优化Prompt模板**
   - 在Prompt中明确要求LLM返回JSON格式
   - 建议使用markdown代码块包裹JSON

4. **考虑使用结构化输出**
   - 部分LLM支持强制JSON输出模式
   - 可以进一步提高提取成功率

## 相关文件

- `backend/services/simple_rag_engine.py` - 核心改进文件
- `storage/results/a88b21b7-ccc3-4a1f-9baf-d732b2478274/` - 测试数据目录

