# 迭代预测功能开发文档 - 第2部分：架构设计

## 2. 架构设计

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          迭代预测系统架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐         ┌──────────────────┐                      │
│  │  前端界面        │         │  后端API         │                      │
│  │  (Next.js)      │◄────────┤  (FastAPI)       │                      │
│  └─────────────────┘         └──────────────────┘                      │
│         │                              │                                │
│         │ 1. 提交迭代预测任务            │                                │
│         │    (配置: max_iterations=5)  │                                │
│         │                              ▼                                │
│         │                    ┌──────────────────┐                      │
│         │                    │  Task Manager    │                      │
│         │                    │  创建任务记录     │                      │
│         │                    └──────────────────┘                      │
│         │                              │                                │
│         │                              ▼                                │
│         │                    ┌──────────────────────────┐              │
│         │                    │  Iterative Prediction    │              │
│         │                    │  Service (LangGraph)     │              │
│         │                    └──────────────────────────┘              │
│         │                              │                                │
│         │              ┌───────────────┼───────────────┐                │
│         │              │               │               │                │
│         │              ▼               ▼               ▼                │
│         │         ┌────────┐     ┌────────┐     ┌────────┐             │
│         │         │ Round 1│     │ Round 2│     │ Round N│             │
│         │         │ (并行)  │     │ (并行)  │     │ (并行)  │             │
│         │         └────────┘     └────────┘     └────────┘             │
│         │              │               │               │                │
│         │              └───────────────┴───────────────┘                │
│         │                              │                                │
│         │                              ▼                                │
│         │                    ┌──────────────────┐                      │
│         │                    │  LLM Config      │                      │
│         │                    │  Loader          │                      │
│         │                    └──────────────────┘                      │
│         │                              │                                │
│         │                              ▼                                │
│         │                    ┌──────────────────┐                      │
│         │                    │  LLM Provider    │                      │
│         │                    │  (Gemini/OpenAI) │                      │
│         │                    └──────────────────┘                      │
│         │                                                                │
│         │ 2. 轮询任务状态                                                 │
│         │    GET /api/tasks/{task_id}                                   │
│         │◄───────────────────────────────────────────────────────────   │
│         │    返回: {current_iteration: 3, progress: 0.6}                │
│         │                                                                │
│         │ 3. 获取迭代历史                                                 │
│         │    GET /api/results/{result_id}/iterations                    │
│         │◄───────────────────────────────────────────────────────────   │
│         │    返回: iteration_history.json                               │
│         │                                                                │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```
输入数据
  │
  ├─ 测试样本 (test_samples.csv)
  │   ├─ Sample_001: [C=0.5%, Si=1.2%, ...]
  │   ├─ Sample_002: [C=0.6%, Si=1.3%, ...]
  │   └─ ...
  │
  ├─ 参考样本 (reference_samples.csv)
  │   ├─ Ref_001: [C=0.5%, Si=1.2%, UTS=850, El=15, ...]
  │   └─ ...
  │
  └─ 迭代配置
      ├─ max_iterations: 5
      ├─ convergence_threshold: 0.01
      ├─ early_stop: true
      └─ max_workers: 5

        ▼

┌─────────────────────────────────────────────────────────────────┐
│                    第1轮迭代 (Iteration 1)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  对每个样本并行执行：                                              │
│  1. 构建 Prompt (使用 UNIFIED_PROTOCOL)                          │
│     - 无历史数据，仅包含参考样本和当前样本                          │
│  2. 调用 LLM 进行预测                                             │
│  3. 解析响应，提取预测值                                           │
│  4. 保存到 iteration_history.json                               │
│                                                                 │
│  Sample_001: UTS=850, El=15                                    │
│  Sample_002: UTS=860, El=14.5                                  │
│  ...                                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

        ▼

┌─────────────────────────────────────────────────────────────────┐
│                  收敛判断 (Convergence Check)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  对每个样本检查：                                                 │
│  - 相对变化率 = |pred_2 - pred_1| / max(|pred_1|, 0.1)          │
│  - 如果 相对变化率 < 0.01，标记为"已收敛"                         │
│  - 如果 所有样本都已收敛，设置 early_stop=true                    │
│                                                                 │
│  Sample_001: 相对变化率=0.005 ✓ 已收敛                           │
│  Sample_002: 相对变化率=0.015 ✗ 继续迭代                         │
│  ...                                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

        ▼

┌─────────────────────────────────────────────────────────────────┐
│                    第2轮迭代 (Iteration 2)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  仅对未收敛的样本执行：                                            │
│  1. 构建 Prompt (使用 ITERATIVE_PROTOCOL)                        │
│     - 包含第1轮的预测值作为历史数据                                │
│     - 格式：Markdown 表格                                        │
│  2. 调用 LLM 进行预测                                             │
│  3. 解析响应，提取预测值                                           │
│  4. 更新 iteration_history.json                                 │
│                                                                 │
│  Sample_002: UTS=862, El=14.3                                  │
│  ...                                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

        ▼

┌─────────────────────────────────────────────────────────────────┐
│                    重复直到收敛或达到最大迭代次数                    │
└─────────────────────────────────────────────────────────────────┘

        ▼

输出数据
  │
  ├─ iteration_history.json
  │   └─ 完整的迭代历史记录
  │
  ├─ process_details.json
  │   └─ 每轮的 Prompt、LLM 响应、解析结果
  │
  └─ 数据库更新
      └─ Task.iteration_history (JSON 字段)
```

### 2.3 模块交互

**核心模块**：

1. **IterativePredictionService** (新增)
   - 职责：协调整个迭代预测流程
   - 依赖：LangGraph, TaskManager, LLMConfigLoader
   - 输入：PredictionConfig (enable_iteration=true)
   - 输出：Task 记录 + iteration_history.json

2. **PromptBuilder** (修改)
   - 新增：ITERATIVE_PROTOCOL 模板
   - 新增：format_iteration_history() 方法
   - 修改：build_prompt() 支持模板选择

3. **SimpleRAGEngine** (修改)
   - 修改：generate_multi_target_prediction() 支持迭代历史参数

4. **LLMConfigLoader** (复用)
   - 所有 LLM 调用必须通过 get_llm() 函数

5. **TaskManager** (复用)
   - 任务创建、状态更新、结果保存

### 2.4 执行流程（时序图）

```
前端                后端API              TaskManager         LangGraph          LLM
  │                   │                    │                   │                 │
  │ 1. POST /iterative-prediction/start    │                   │                 │
  ├──────────────────────────────────────►│                   │                 │
  │                   │                    │                   │                 │
  │                   │ 2. 创建 Task 记录    │                   │                 │
  │                   ├───────────────────►│                   │                 │
  │                   │◄───────────────────┤                   │                 │
  │                   │ task_id=123        │                   │                 │
  │                   │                    │                   │                 │
  │ 3. 返回 task_id   │                    │                   │                 │
  │◄──────────────────┤                    │                   │                 │
  │                   │                    │                   │                 │
  │                   │ 4. 后台启动迭代预测  │                   │                 │
  │                   ├───────────────────────────────────────►│                 │
  │                   │                    │                   │                 │
  │                   │                    │                   │ 5. 第1轮迭代      │
  │                   │                    │                   │ (并行处理样本)    │
  │                   │                    │                   ├────────────────►│
  │                   │                    │                   │◄────────────────┤
  │                   │                    │                   │ 预测值           │
  │                   │                    │                   │                 │
  │                   │                    │                   │ 6. 收敛判断      │
  │                   │                    │                   │ (检查所有样本)    │
  │                   │                    │                   │                 │
  │ 7. GET /tasks/123 │                    │                   │                 │
  ├──────────────────────────────────────►│                   │                 │
  │                   │ 8. 返回任务状态      │                   │                 │
  │◄──────────────────┤ {current_iteration: 1, progress: 0.5}  │                 │
  │                   │                    │                   │                 │
  │ 9. 轮询直到完成    │                    │                   │                 │
  │ (每2秒一次)       │                    │                   │                 │
  │                   │                    │                   │                 │
  │                   │                    │                   │ 10. 第2轮迭代    │
  │                   │                    │                   │ (仅未收敛样本)    │
  │                   │                    │                   ├────────────────►│
  │                   │                    │                   │◄────────────────┤
  │                   │                    │                   │                 │
  │                   │                    │                   │ 11. 重复直到收敛 │
  │                   │                    │                   │ 或达到最大迭代   │
  │                   │                    │                   │                 │
  │ 12. GET /results/123/iterations        │                   │                 │
  ├──────────────────────────────────────►│                   │                 │
  │                   │ 13. 返回迭代历史    │                   │                 │
  │◄──────────────────┤ iteration_history.json                │                 │
  │                   │                    │                   │                 │
```

