# 任务对比分析页面优化说明

## 更新日期
2025-12-07

## 优化内容

### 1. 可折叠任务选择卡片（顶部设计）

#### 变更前
- 使用单选模式切换显示方式（任务ID、备注、文件名、自定义名称）
- 任务列表只显示选中模式的单一信息
- 需要通过切换模式才能查看不同字段
- 任务选择区域位于左侧配置面板中
- 无法折叠，始终占用空间

#### 变更后
- **顶部卡片式设计**：任务选择区域移至页面顶部，更加醒目
- **可折叠设计**：默认折叠，点击展开查看详细信息
- **双模式显示**：
  - **折叠模式**：简洁的标签式任务列表，快速选择
  - **展开模式**：详细的表格视图，可编辑所有信息
- **渐变背景**：蓝色到靛蓝色渐变背景，视觉效果更佳

#### 折叠模式特性（富信息卡片）
- **卡片式布局**：任务以信息卡片形式横向排列
- **序号徽章**：每个任务前有渐变色序号标识（1, 2, 3...）
- **多层次信息显示**：
  - **主标题**：根据显示模式显示主要名称（粗体、较大字体）
  - **辅助信息**：自动显示其他关键字段（备注、自定义名称、文件名、任务ID）
  - **智能过滤**：避免重复显示已作为主标题的字段
  - **图标标识**：每个字段前有对应图标（💬备注、🏷️自定义、📄文件、💻ID）
- **信息截断**：长文本自动截断并显示省略号（备注30字符，文件名25字符）
- **悬停提示**：鼠标悬停显示完整内容
- **快速选择**：点击卡片即可选择/取消选择任务
- **选中高亮**：选中的任务显示蓝色背景、白色文字和阴影效果
- **节省空间**：折叠后占用较少垂直空间，同时保留关键信息可见性

#### 展开模式特性
- **表格式并排展示**所有任务信息
- 表格包含以下列：
  - ☑️ 选择框（支持全选/取消全选）
  - 📋 任务ID（带序号标识 + 前8位代码）
  - 📝 备注（可直接编辑）
  - 📄 文件名（带文件图标）
  - ✏️ 自定义名称（可直接输入）

#### 卡片特性
- **折叠按钮**：左上角下拉箭头按钮，带旋转动画
- **渐变背景**：from-blue-50 to-indigo-50，视觉层次分明
- **动态统计**：实时显示已选择任务数量
- **显示模式选择器**：展开时显示（ID/备注/文件名/自定义）
- **全选按钮**：展开时显示，快捷全选/取消全选
- **使用提示**：展开时显示底部蓝色提示框

#### 表格特性（展开模式）
- **固定表头**：滚动时表头保持可见（sticky top-0）
- **最大高度限制**：320px，超出自动滚动
- **响应式设计**：水平滚动支持小屏幕
- **选中高亮**：已选择的任务行显示蓝色背景（bg-blue-50）
- **悬停效果**：鼠标悬停时行背景变化
- **序号标识**：每行前有渐变色序号徽章（1, 2, 3...）
- **代码样式**：任务ID使用等宽字体和灰色背景

### 2. 备注实时编辑功能

#### 编辑方式
1. **点击备注单元格**进入编辑模式
2. 输入框自动获得焦点，带蓝色边框高亮
3. 支持快捷键：
   - `Enter` - 保存
   - `Escape` - 取消

#### 编辑界面
- 编辑时显示输入框和操作按钮
- ✅ 绿色圆角按钮 - 保存（bg-green-600）
- ❌ 红色圆角按钮 - 取消（bg-red-600）
- 未编辑时显示铅笔图标提示可编辑（悬停时显示）
- 输入框带 2px 蓝色边框和圆角设计

#### 空备注提示
- 显示灰色斜体文字："点击添加备注..."
- 鼠标悬停时文字变为蓝色（group-hover:text-blue-600）
- 提供视觉引导，鼓励用户添加备注

### 3. 自定义名称直接编辑

#### 功能特点
- 每个任务行都有自定义名称输入框
- 实时输入，自动保存到 localStorage
- 用于图表中的任务标识显示

#### 显示优先级
图表中任务名称显示优先级：
1. 自定义名称（最高优先级）
2. 备注
3. 文件名
4. 任务ID（最低优先级）

### 4. 跨组件同步更新机制

#### 事件系统
使用 `taskEvents` 事件管理器实现跨组件通信：

```typescript
// 触发更新（在 task-comparison.tsx 中）
taskEvents.emit('note-updated', {
  taskId: string,
  field: 'note',
  value: string
});

// 监听更新（在所有相关组件中）
taskEvents.on('note-updated', (data) => {
  // 更新本地状态
});
```

#### 同步范围
备注修改会实时同步到以下所有位置：
- ✅ 任务对比分析页面（task-comparison.tsx）
- ✅ 任务列表页面（tasks.tsx）
- ✅ 结果详情页面（results/[id].tsx）
- ✅ 任务侧边栏组件（TaskSidebar.tsx）
- ✅ 跨浏览器标签页（通过 localStorage 事件）

#### 实现细节
1. **本地更新**：立即更新当前组件状态
2. **事件触发**：通过 taskEvents.emit 广播更新
3. **跨标签页**：利用 localStorage 的 storage 事件
4. **自动清理**：组件卸载时自动取消事件监听

### 5. 用户体验优化

#### 视觉设计
- **渐变背景**：卡片使用蓝色到靛蓝色渐变（from-blue-50 to-indigo-50）
- **图标系统**：每个功能区域都有对应的图标标识
- **序号徽章**：任务行前有渐变色序号（from-blue-500 to-indigo-600）
- **选中高亮**：选中行蓝色背景（bg-blue-50 hover:bg-blue-100）
- **悬停效果**：未选中行悬停灰色背景（hover:bg-gray-50）
- **边框设计**：卡片使用 2px 蓝色边框（border-2 border-blue-200）
- **圆角设计**：所有元素统一使用圆角（rounded-lg/rounded-xl）
- **阴影效果**：卡片和表格带轻微阴影（shadow-sm）

#### 交互反馈
- **编辑状态**：2px 蓝色边框 + 聚焦环（focus:ring-2 focus:ring-blue-500）
- **按钮状态**：绿色保存（bg-green-600）/ 红色取消（bg-red-600）
- **全选按钮**：白色背景 + 蓝色边框（bg-white border-blue-300）
- **输入框悬停**：边框颜色变化（hover:border-blue-400）

#### 交互提示
- **顶部统计**：实时显示"X 个任务已选择"或"请选择至少 2 个任务进行对比"
- **底部提示框**：蓝色背景提示框，包含三条使用提示
  - 点击备注单元格可编辑（Enter 保存，Esc 取消）
  - 自定义名称将用于图表中的任务标识显示
  - 选择至少 2 个任务后可开始对比分析
- **空状态提示**：未找到任务时显示图标 + 引导文字
- **工具提示**：所有按钮都有 title 属性提示

#### 性能优化
- 使用 `prevTasks` 避免不必要的重渲染
- 事件监听器自动清理防止内存泄漏
- localStorage 延迟清理避免事件冲突
- 表格虚拟滚动（最大高度 320px）

## 技术实现

### 状态管理
```typescript
// 编辑状态
const [editingTaskId, setEditingTaskId] = useState<string | null>(null);
const [editingNote, setEditingNote] = useState<string>('');

// 自定义名称（持久化到 localStorage）
const [customTaskNames, setCustomTaskNames] = useState<{ [taskId: string]: string }>({});
```

### API 调用
```typescript
// PATCH /api/tasks/{task_id}/note
await fetch(`http://localhost:8000/api/tasks/${taskId}/note`, {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ note: editingNote }),
});
```

### 事件同步
```typescript
// 监听备注更新
useEffect(() => {
  const handleNoteUpdate = (data: { taskId: string; field?: string; value?: any }) => {
    setTasks(prevTasks =>
      prevTasks.map(t =>
        t.task_id === data.taskId ? { ...t, note: data.value } : t
      )
    );
  };

  taskEvents.on('note-updated', handleNoteUpdate);
  return () => taskEvents.off('note-updated', handleNoteUpdate);
}, []);
```

## 视觉效果对比

### 优化前
```
┌─────────────────────────────────────┐
│ Configuration                       │
├─────────────────────────────────────┤
│ 任务显示方式:                        │
│ [任务ID] [备注] [文件名] [自定义]    │
│                                     │
│ Select Tasks (0 selected)           │
│ ┌─────────────────────────────────┐ │
│ │ ☐ a147e954... 100_99_gemin...   │ │
│ │ ☐ d8658dbb... 100_99_gemin...   │ │
│ │ ☐ c3e147bd... [2025-12-06 1...  │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 优化后 - 折叠模式（默认）
```
┌──────────────────────────────────────────────────────────────────────────┐
│ ▼ 选择任务                    [ID][备注][文件名][自定义]  [全选/取消全选] │
│    3 个任务已选择                                                        │
├──────────────────────────────────────────────────────────────────────────┤
│ ┌──────────────────────┐ ┌──────────────────────┐ ┌──────────────────┐ │
│ │ ① 测试任务            │ │ ② 生产数据            │ │ ③ a147e954       │ │
│ │ 💬 这是测试数据       │ │ 💬 正式环境数据       │ │ 📄 100_99_gem... │ │
│ │ 🏷️ Test-v1           │ │ 📄 production.csv    │ │ 💻 a147e954      │ │
│ │ 📄 test_data.csv     │ │ 💻 d8658dbb          │ │                  │ │
│ │ 💻 c3e147bd          │ │                      │ │                  │ │
│ └──────────────────────┘ └──────────────────────┘ └──────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

### 优化后 - 展开模式
```
┌──────────────────────────────────────────────────────────────────────────┐
│ ▲ 选择任务                    [ID][备注][文件名][自定义]  [全选/取消全选] │
│    3 个任务已选择                                                        │
├──────────────────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────────────────────┐   │
│ │ ☑ │ 任务ID    │ 备注          │ 文件名        │ 自定义名称       │   │
│ ├───┼──────────┼──────────────┼──────────────┼─────────────────┤   │
│ │ ☑ │ ① a147e9 │ 测试数据 ✏️   │ 📄 test_da... │ Test-v1         │   │
│ │ ☑ │ ② d8658d │ 生产数据 ✏️   │ 📄 produc...  │ Production-v2   │   │
│ │ ☐ │ ③ c3e147 │ 点击添加...   │ 📄 100_99...  │ [输入框]        │   │
│ └────────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│ 💡 使用提示                                                              │
│ • 点击备注单元格可编辑（Enter 保存，Esc 取消）                            │
│ • 自定义名称将用于图表中的任务标识显示                                    │
│ • 选择至少 2 个任务后可开始对比分析                                      │
│ • 使用上方按钮切换任务显示方式（ID/备注/文件名/自定义）                   │
└──────────────────────────────────────────────────────────────────────────┘
```

## 移除的功能

### 任务显示方式选择器
- 移除了四个单选按钮（任务ID、备注、文件名、自定义）
- 移除了"Edit Names"按钮
- 移除了自定义名称编辑器对话框

### 原因
- 表格式展示已包含所有信息，无需切换
- 自定义名称可直接在表格中编辑，无需单独对话框
- 简化界面，提升用户体验
- 顶部卡片设计更加醒目，用户一眼就能看到任务选择区域

## 兼容性说明

### 向后兼容
- localStorage 中的 `taskComparisonCustomNames` 继续使用
- 移除了 `taskComparisonDisplayMode`（不再需要）
- 现有的 taskEvents 系统保持不变

### 数据迁移
无需数据迁移，现有自定义名称数据自动保留。

## 测试建议

1. **编辑功能测试**
   - 点击备注单元格进入编辑模式
   - 输入内容后按 Enter 保存
   - 输入内容后按 Escape 取消
   - 点击保存/取消按钮

2. **同步测试**
   - 在任务对比页面修改备注
   - 切换到任务列表页面查看是否同步
   - 切换到结果详情页面查看是否同步
   - 打开新标签页验证跨标签页同步

3. **自定义名称测试**
   - 在表格中输入自定义名称
   - 执行对比查看图表中的任务标识
   - 刷新页面验证持久化

4. **全选功能测试**
   - 点击表头复选框全选
   - 再次点击取消全选
   - 手动选择所有任务验证表头复选框状态

## 文件变更清单

### 修改的文件
- `frontend/pages/task-comparison.tsx` - 主要优化文件

### 未修改的文件（已验证兼容）
- `frontend/pages/tasks.tsx` - 已有 taskEvents 监听
- `frontend/pages/results/[id].tsx` - 已有 taskEvents 监听
- `frontend/lib/taskEvents.ts` - 事件系统保持不变
- `backend/api/tasks.py` - API 保持不变

