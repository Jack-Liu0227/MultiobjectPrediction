# 错误修复说明 v1.0

## 修复日期
2025-12-07

## 修复的问题

### 1. LLM API 500 内部服务器错误

**问题描述:**
```
LLM prediction failed: litellm.InternalServerError: InternalServerError: 
OpenAIException - Internal server error during chat_completion
Error code: 500
```

**原因分析:**
- LLM API 服务端临时性故障
- 网络波动导致请求失败
- 缺少重试机制，一次失败就放弃

**解决方案:**
在 `backend/services/simple_rag_engine.py` 中添加重试机制：
- 最多重试 3 次
- 指数退避策略（2秒 → 4秒 → 8秒）
- 仅对可重试错误（500、InternalServerError）进行重试
- 详细的日志记录每次重试尝试

**代码位置:**
- 文件: `backend/services/simple_rag_engine.py`
- 行数: 300-416
- 关键改动: 添加 `max_retries` 和 `retry_delay` 逻辑

---

### 2. 文件权限错误 (Permission Denied)

**问题描述:**
```
❌ 文件权限错误: [Errno 13] Permission denied
```

**原因分析:**
- Windows 系统文件被其他进程占用
- 多线程并发写入同一文件
- 文件正在被读取时尝试写入

**解决方案:**

#### 2.1 任务文件读写重试
在 `backend/services/task_manager.py` 中：
- `_save_task()`: 添加 3 次重试，延迟 0.5 秒
- `_load_task()`: 添加 3 次重试，延迟 0.3 秒
- 处理 Windows 文件删除/重命名的特殊情况

#### 2.2 结果文件安全写入
在 `backend/services/rag_prediction_service.py` 中：
- 新增 `safe_write_file()` 辅助函数
- 应用到所有文件写入操作：
  - `inputs/sample_*.txt` (prompt 文件)
  - `outputs/sample_*.txt` (response 文件)
  - `process_details.json`
  - `metrics.json`

**代码位置:**
- `backend/services/task_manager.py`: 203-316 行
- `backend/services/rag_prediction_service.py`: 27-56 行（辅助函数）

---

### 3. 缺失属性错误

**问题描述:**
```
'RAGPredictionService' object has no attribute 'results_dir'
```

**原因分析:**
- `RAGPredictionService.__init__()` 中未初始化 `results_dir` 属性
- 代码在多处使用 `self.results_dir` 但未定义

**解决方案:**
在 `__init__()` 方法中添加：
```python
self.results_dir = RESULTS_DIR
```

**代码位置:**
- 文件: `backend/services/rag_prediction_service.py`
- 行数: 74

---

## 改进效果

### ✅ 提高稳定性
- LLM API 临时故障自动恢复
- 文件操作冲突自动重试
- 减少任务失败率

### ✅ 更好的日志
- 清晰标识重试过程
- 记录失败原因和次数
- 便于问题排查

### ✅ 优雅降级
- 重试失败后使用默认值（0.0）
- 不会导致整个任务崩溃
- 保证任务能够完成

---

## 使用建议

### 重启服务
修复后需要重启后端服务：

```powershell
# 停止后端（在运行后端的终端按 Ctrl+C）

# 重新启动
cd backend
uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 监控日志
观察日志中的重试信息：
- `Retry attempt X/3 for model: ...` - LLM 重试
- `文件被占用，重试读取 (尝试 X/3)` - 文件读取重试
- `文件写入失败，重试 (尝试 X/3)` - 文件写入重试

### 调整参数
如需调整重试策略，修改以下参数：

**LLM 重试:**
```python
# backend/services/simple_rag_engine.py, 行 310-311
max_retries = 3      # 最大重试次数
retry_delay = 2      # 初始延迟（秒）
```

**文件操作重试:**
```python
# backend/services/task_manager.py
max_retries = 3      # 最大重试次数
retry_delay = 0.5    # 延迟（秒）
```

---

## 相关文件

- `backend/services/simple_rag_engine.py` - LLM 调用重试
- `backend/services/task_manager.py` - 任务文件读写重试
- `backend/services/rag_prediction_service.py` - 结果文件安全写入

