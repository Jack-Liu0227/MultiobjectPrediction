# 修复验证步骤

## 验证 Confidence 字段解析修复

### 1. 检查后端解析逻辑

运行以下命令重新提取 confidence 字段:

```bash
# 为单个任务重新提取
python scripts/add_confidence_to_existing_results.py d0f18aa6-410e-44f7-a331-248952cec873

# 为所有任务重新提取
python scripts/add_confidence_to_existing_results.py --all
```

### 2. 验证结果

检查输出应该显示:
- ✅ 任务 d0f18aa6: 47/47 样本成功提取 confidence
- ⚠️ 任务 e8dfb250: 19/20 样本成功提取 confidence (1个失败是因为LLM返回错误)

### 3. 检查文件

查看 `storage/results/{task_id}/predictions.csv`,确认:
- ✅ 包含 `confidence` 列
- ✅ 值为 `high`, `medium`, 或 `low`

---

## 验证可视化图表动态筛选

### 1. 启动前端服务

```bash
cd frontend
npm run dev
```

### 2. 访问任务结果页面

访问: `http://localhost:3000/results/{task_id}`

例如: `http://localhost:3000/results/d0f18aa6-410e-44f7-a331-248952cec873`

### 3. 测试"真实值 vs 预测值对比"图表

1. 点击 **"可视化图表"** 标签页
2. 查看 **"真实值 vs 预测值对比"** 部分
3. 使用置信度筛选器切换不同选项:
   - All Data
   - High Confidence
   - Medium Confidence
   - Low Confidence

**预期结果:**
- ✅ 图表中的散点数量应该随筛选条件变化
- ✅ 图表上方的评估指标 (R², RMSE, MAE, MAPE) 应该动态更新
- ✅ 数值应该根据筛选后的数据重新计算

**验证方法:**
1. 选择 "All Data",记录 R² 值 (例如: 81.1%)
2. 选择 "High Confidence",R² 值应该变化 (例如: 85.3%)
3. 选择 "Medium Confidence",R² 值应该再次变化 (例如: 76.8%)

### 4. 测试"预测误差分布"图表

1. 在 **"可视化图表"** 标签页
2. 查看 **"预测误差分布"** 部分
3. 使用置信度筛选器切换不同选项

**预期结果:**
- ✅ 误差分布柱状图应该随筛选条件变化
- ✅ 统计信息 (均值、中位数、标准差) 应该动态更新
- ✅ "误差 < 5%"、"误差 < 10%" 的样本数应该变化

### 5. 测试"预测值 vs 真实值散点图"

1. 点击 **"预测对比散点图"** 标签页
2. 使用置信度筛选器切换不同选项
3. 选择一个目标属性 (例如: UTS(MPa))

**预期结果:**
- ✅ 散点图中的点数应该随筛选条件变化
- ✅ 图表下方的评估指标卡片应该显示:
  - R² Score (小数和百分比)
  - RMSE
  - MAE
  - 样本数量
- ✅ 这些指标应该根据筛选条件动态更新

**验证方法:**
1. 选择 "All Data",记录样本数 (例如: 47个样本)
2. 选择 "High Confidence",样本数应该减少 (例如: 23个样本)
3. 评估指标应该基于这23个样本重新计算

---

## 常见问题排查

### 问题1: 前端页面没有显示置信度筛选器

**原因:** 数据中没有 confidence 字段

**解决方法:**
1. 运行 `python scripts/add_confidence_to_existing_results.py --all`
2. 刷新浏览器页面

### 问题2: 评估指标没有变化

**原因:** 浏览器缓存了旧版本的代码

**解决方法:**
1. 硬刷新浏览器 (Ctrl+Shift+R 或 Cmd+Shift+R)
2. 清除浏览器缓存
3. 重启前端开发服务器

### 问题3: 某些样本的 confidence 为 null

**原因:** LLM 返回了错误信息或无效的 JSON

**解决方法:**
- 这是预期行为,无法从错误响应中提取 confidence
- 这些样本在筛选时会被排除在所有置信度级别之外

---

## 成功标准

所有以下条件都应该满足:

- ✅ Confidence 字段成功提取 (除了LLM错误响应的样本)
- ✅ predictions.csv 包含 confidence 列
- ✅ 前端页面显示置信度筛选器
- ✅ "真实值 vs 预测值对比" 的评估指标动态更新
- ✅ "预测误差分布" 图表动态更新
- ✅ "预测值 vs 真实值散点图" 显示动态评估指标
- ✅ 所有图表的样本数随筛选条件变化
- ✅ 评估指标的数值随筛选条件变化

---

## 性能验证

### 检查计算性能

1. 打开浏览器开发者工具 (F12)
2. 切换到 "Performance" 或 "性能" 标签
3. 开始录制
4. 切换置信度筛选器多次
5. 停止录制

**预期结果:**
- ✅ 每次切换应该在 100ms 内完成
- ✅ 没有明显的卡顿或延迟
- ✅ 使用了 React.memo 和 useMemo 优化

---

## 回归测试

确保修复没有破坏现有功能:

1. ✅ 导出功能仍然正常工作 (PNG, CSV, HTML)
2. ✅ 点击散点图的点仍然能显示详情
3. ✅ 所有图表仍然正确渲染
4. ✅ 评估指标标签页仍然正常显示
5. ✅ 任务对比功能仍然正常工作

