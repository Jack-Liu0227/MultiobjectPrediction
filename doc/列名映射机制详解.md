# 列名映射机制详解

## 1. 列名映射的实现位置

### 1.1 配置存储位置

**文件路径**：`storage/prompt_templates/{template_id}.json`

**数据结构**：
```json
{
  "template_name": "默认多目标模板",
  "template_type": "multi_target",
  "column_name_mapping": {
    "Processing": "Heat treatment method",
    "Composition": "Alloy Composition",
    "Processing_Description": "Heat treatment method",
    "Aging_Treatment(K)": "Aging Temperature"
  },
  "system_role": "...",
  "task_description": "...",
  ...
}
```

**默认映射定义**：
- 文件：`backend/services/prompt_template_manager.py`
- 位置：第 38-41 行
```python
default_column_mapping = {
    "Processing": "Heat treatment method",
    "Composition": "Alloy Composition"
}
```

### 1.2 列名映射的传递路径

#### 路径 1：预览 API
```
前端 PromptTemplateEditor
  ↓ (HTTP POST /api/prompt-templates/preview)
backend/api/prompt_templates.py (第 121 行)
  ↓ column_name_mapping = request.column_name_mapping
PromptBuilder.__init__() (第 14 行)
  ↓ self.column_name_mapping = column_name_mapping
PromptBuilder.build_prompt() (第 169 行)
  ↓ 应用列名映射
最终 Prompt
```

#### 路径 2：实际预测
```
前端发起预测请求
  ↓ (HTTP POST /api/prediction/predict)
backend/api/prediction.py
  ↓ config.prompt_template (包含 column_name_mapping)
backend/services/rag_prediction_service.py (第 561 行)
  ↓ custom_template=config.prompt_template
backend/services/simple_rag_engine.py (第 217 行)
  ↓ column_name_mapping = custom_template["column_name_mapping"]
PromptBuilder.__init__() (第 14 行)
  ↓ self.column_name_mapping = column_name_mapping
PromptBuilder.build_prompt() (第 169 行)
  ↓ 应用列名映射
最终 Prompt
```

---

## 2. 列名映射的应用逻辑

### 2.1 应用位置

**核心文件**：`backend/services/prompt_builder.py`

**核心方法**：`_apply_column_name_mapping()` (第 150-167 行)

```python
def _apply_column_name_mapping(self, text: str) -> str:
    """
    应用列名映射到文本中
    
    Args:
        text: 原始文本，例如 "Composition: ...\nProcessing_Description: ..."
    
    Returns:
        映射后的文本，例如 "Composition: ...\nHeat treatment method: ..."
    """
    result = text
    for old_name, new_name in self.column_name_mapping.items():
        # 替换 "old_name:" 为 "new_name:"
        result = result.replace(f"{old_name}:", f"{new_name}:")
    return result
```

### 2.2 应用时机

**时机**：在 `PromptBuilder.build_prompt()` 方法中，构建最终提示词时应用

**具体位置**：

1. **测试样本映射** (第 207 行 和 第 296 行)：
```python
# 应用列名映射到测试样本（根据 apply_mapping_to_target 选项）
mapped_test_sample = self._apply_column_name_mapping(test_sample) if self.apply_mapping_to_target else test_sample
```

2. **参考样本映射** (第 466 行 和 第 489 行)：
```python
# 应用列名映射到每个参考样本
mapped_sample_text = self._apply_column_name_mapping(sample_text)
```

### 2.3 应用流程图

```
原始样本文本 (由 SampleTextBuilder 构建)
├─ Processing_Description: Homogenization at 298K
└─ Aging_Treatment(K): 1173
    ↓
PromptBuilder._apply_column_name_mapping()
    ↓
映射后的样本文本
├─ Heat treatment method: Homogenization at 298K  # 如果配置了映射
└─ Aging_Treatment(K): 1173
    ↓
插入到最终 Prompt 中
```

---

## 3. 统一控制机制

### 3.1 统一的工具类

**工具类**：`PromptBuilder` (backend/services/prompt_builder.py)

**职责**：
- 存储列名映射配置 (`self.column_name_mapping`)
- 应用列名映射 (`_apply_column_name_mapping()`)
- 构建最终提示词 (`build_prompt()`)

### 3.2 确保一致性的机制

#### 机制 1：所有代码路径都使用 `PromptBuilder`

**预览 API** (`backend/api/prompt_templates.py` 第 131-135 行)：
```python
prompt_builder = PromptBuilder(
    custom_template=template_dict,
    column_name_mapping=column_name_mapping,
    apply_mapping_to_target=request.apply_mapping_to_target
)
```

**实际预测** (`backend/services/simple_rag_engine.py` 第 242-246 行)：
```python
prompt_builder = PromptBuilder(
    custom_template=custom_template,
    column_name_mapping=column_name_mapping,
    apply_mapping_to_target=apply_mapping_to_target
)
```

#### 机制 2：列名映射只在一个地方应用

**关键设计决策**：列名映射只在 `PromptBuilder.build_prompt()` 中应用，避免重复映射。

**历史问题**（已修复）：
- 之前在 `simple_rag_engine.py` 中使用 `get_column_label()` 提前应用映射
- 导致双重映射问题
- 现已移除，统一在 `PromptBuilder` 中应用

### 3.3 修改列名映射逻辑需要修改的文件

**只需修改一个文件**：`backend/services/prompt_builder.py`

具体修改位置：
- `_apply_column_name_mapping()` 方法 (第 150-167 行)

**示例**：如果需要支持正则表达式映射，只需修改这一个方法。

---

## 4. 与 SampleTextBuilder 的关系

### 4.1 职责分离

**SampleTextBuilder** (`backend/services/sample_text_builder.py`)：
- **职责**：使用原始列名构建样本文本
- **不应用**列名映射
- **输出**：`Processing_Description: value\nAging_Treatment(K): value`

**PromptBuilder** (`backend/services/prompt_builder.py`)：
- **职责**：应用列名映射，构建最终提示词
- **应用**列名映射
- **输出**：`Heat treatment method: value\nAging_Treatment(K): value`

### 4.2 为什么在 PromptBuilder 而不是 SampleTextBuilder 中应用映射？

#### 原因 1：职责单一原则
- `SampleTextBuilder` 负责数据提取和格式化
- `PromptBuilder` 负责提示词构建和样式控制
- 列名映射属于"样式控制"，应该在 `PromptBuilder` 中

#### 原因 2：灵活性
- 同一个样本文本可能需要不同的映射（不同的模板）
- 如果在 `SampleTextBuilder` 中应用映射，需要为每个模板重新构建样本文本
- 在 `PromptBuilder` 中应用映射，可以复用样本文本

#### 原因 3：RAG 检索需要原始列名
- RAG 嵌入和检索使用原始样本文本（未映射）
- 只有在构建最终提示词时才需要映射
- 如果在 `SampleTextBuilder` 中应用映射，会影响 RAG 检索效果

### 4.3 数据流示意图

```
DataFrame Row
    ↓
SampleTextBuilder.build_from_dataframe_row()
    ↓ (使用原始列名)
原始样本文本: "Processing_Description: value"
    ↓
RAG 嵌入和检索 (使用原始文本)
    ↓
PromptBuilder.build_prompt()
    ↓ (应用列名映射)
映射后的样本文本: "Heat treatment method: value"
    ↓
最终 Prompt
```

---

## 5. 设计决策总结

### 5.1 核心原则

1. **单一职责**：每个模块只负责一件事
2. **统一控制**：列名映射只在一个地方应用
3. **延迟映射**：尽可能晚地应用映射（在最终提示词构建时）

### 5.2 关键优势

1. **易于维护**：修改映射逻辑只需修改一个文件
2. **避免重复**：不会出现双重映射问题
3. **灵活性高**：同一样本文本可以应用不同的映射
4. **RAG 友好**：不影响嵌入和检索效果

### 5.3 未来扩展

如果需要支持更复杂的映射逻辑（如正则表达式、条件映射），只需：
1. 修改 `PromptBuilder._apply_column_name_mapping()` 方法
2. 扩展 `column_name_mapping` 的数据结构

**示例**：
```python
# 当前：简单字符串替换
column_name_mapping = {
    "Processing_Description": "Heat treatment method"
}

# 未来：支持正则表达式
column_name_mapping = {
    "Processing_.*": "Heat treatment method",  # 匹配所有 Processing_ 开头的列
    "Aging_.*": "Aging conditions"
}
```

---

## 6. 关键代码位置速查表

| 功能 | 文件路径 | 行号 | 说明 |
|------|---------|------|------|
| 默认映射定义 | `backend/services/prompt_template_manager.py` | 38-41 | 定义默认的列名映射 |
| 映射配置存储 | `storage/prompt_templates/{template_id}.json` | - | JSON 文件中的 `column_name_mapping` 字段 |
| 映射应用逻辑 | `backend/services/prompt_builder.py` | 150-167 | `_apply_column_name_mapping()` 方法 |
| 测试样本映射 | `backend/services/prompt_builder.py` | 207, 296 | 在 `build_prompt()` 中应用 |
| 参考样本映射 | `backend/services/prompt_builder.py` | 466, 489 | 在构建参考样本时应用 |
| 预览 API 传递 | `backend/api/prompt_templates.py` | 121-135 | 从请求中提取映射配置 |
| 预测 API 传递 | `backend/services/simple_rag_engine.py` | 217-220 | 从自定义模板中提取映射配置 |
| 样本文本构建 | `backend/services/sample_text_builder.py` | 全文件 | 使用原始列名，不应用映射 |

---

## 7. 常见问题 FAQ

### Q1: 为什么预览结果和实际预测结果不一致？

**A**: 检查以下几点：
1. 预览 API 和实际预测是否使用了相同的 `column_name_mapping`
2. 是否在多个地方应用了列名映射（导致双重映射）
3. `SampleTextBuilder` 是否错误地应用了映射（应该只使用原始列名）

### Q2: 如何添加新的列名映射？

**A**: 在前端提示词模板编辑器中：
1. 找到"列名映射配置"部分
2. 添加新的映射条目：`原始列名 → 显示名称`
3. 保存模板

或者直接编辑 `storage/prompt_templates/{template_id}.json` 文件。

### Q3: 列名映射是否区分大小写？

**A**: 是的，当前实现使用 `str.replace()`，区分大小写。
- `Processing:` 会被替换
- `processing:` 不会被替换

### Q4: 如何调试列名映射问题？

**A**:
1. 在 `PromptBuilder._apply_column_name_mapping()` 方法中添加日志：
```python
logger.info(f"应用列名映射前: {text[:100]}")
logger.info(f"映射配置: {self.column_name_mapping}")
logger.info(f"应用列名映射后: {result[:100]}")
```

2. 检查保存的 prompt 文件：`storage/results/{task_id}/inputs/sample_*.txt`

3. 对比预览结果和实际预测的 prompt 文件

### Q5: 为什么有些列名没有被映射？

**A**: 可能的原因：
1. 映射配置中没有包含该列名
2. 列名拼写不匹配（注意大小写和空格）
3. 列名后面没有冒号（映射只替换 `列名:` 格式）

---

## 8. 完整示例

### 8.1 配置示例

**模板文件** (`storage/prompt_templates/my_template.json`):
```json
{
  "template_name": "我的自定义模板",
  "template_type": "multi_target",
  "column_name_mapping": {
    "Processing_Description": "热处理方法",
    "Aging_Treatment(K)": "时效温度",
    "Composition": "合金成分"
  },
  "system_role": "你是材料科学专家",
  "task_description": "预测材料性能",
  ...
}
```

### 8.2 数据流示例

**输入数据** (DataFrame row):
```python
{
    "Processing_Description": "Homogenization at 298K",
    "Aging_Treatment(K)": "1173",
    "Al(wt%)": "5.3",
    "Co(wt%)": "21"
}
```

**步骤 1**: `SampleTextBuilder` 构建原始样本文本
```
Composition: Al 5.3, Co 21
Processing_Description: Homogenization at 298K
Aging_Treatment(K): 1173
```

**步骤 2**: `PromptBuilder._apply_column_name_mapping()` 应用映射
```
合金成分: Al 5.3, Co 21
热处理方法: Homogenization at 298K
时效温度: 1173
```

**步骤 3**: 插入到最终 Prompt
```
### Task
预测材料性能

**Target Material**:
合金成分: Al 5.3, Co 21
热处理方法: Homogenization at 298K
时效温度: 1173

**Reference Samples**:
...
```

---

## 9. 总结

### 核心要点

1. **配置存储**：列名映射存储在提示词模板的 JSON 文件中
2. **统一应用**：只在 `PromptBuilder._apply_column_name_mapping()` 中应用
3. **职责分离**：`SampleTextBuilder` 使用原始列名，`PromptBuilder` 应用映射
4. **延迟映射**：在构建最终提示词时才应用映射，不影响 RAG 检索
5. **易于维护**：修改映射逻辑只需修改一个方法

### 设计优势

- ✅ 避免双重映射
- ✅ 预览和预测结果一致
- ✅ 易于扩展和维护
- ✅ 不影响 RAG 检索效果

