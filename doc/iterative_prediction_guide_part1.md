# 迭代预测功能开发文档 - 第1部分

## 1. 功能概述

### 1.1 功能背景

当前系统仅支持单次预测：输入材料组分和工艺参数，LLM 基于参考样本预测目标属性值。本次开发将引入**迭代预测功能**，允许系统将每次预测的结果作为下一次预测的输入，形成闭环优化，直到预测值收敛或达到最大迭代次数。

### 1.2 核心价值

1. **提高预测精度**：通过多轮迭代，LLM 可以逐步修正初始预测中的偏差
2. **增强可解释性**：记录每次迭代的推理过程，展示预测值的演化趋势
3. **支持复杂场景**：对于难以一次性准确预测的材料体系，迭代方法提供更可靠的结果
4. **收敛分析**：通过收敛速度和趋势，评估预测的稳定性和可信度

### 1.3 用户故事

**故事1：材料研究员的迭代优化**
> 作为一名材料研究员，我希望系统能够对新型合金的力学性能进行多轮预测，每次迭代都基于上一次的结果进行改进，这样我可以看到预测值的收敛过程，从而判断预测的可靠性。

**故事2：对比单次预测和迭代预测**
> 作为一名数据科学家，我希望能够对比单次预测和迭代预测的结果差异，分析迭代是否真正提升了预测精度，以及哪些样本受益于迭代。

**故事3：失败样本的重试**
> 作为一名系统管理员，我希望在迭代预测过程中，如果某些样本因为 API 错误而失败，系统能够记录失败信息并允许我稍后重试这些样本，而不是重新运行整个任务。

### 1.4 功能边界

**包含的功能**：
- ✅ 可配置的迭代次数（1-10次）
- ✅ 基于相对变化率的收敛判断
- ✅ 提前停止机制（所有样本收敛后自动终止）
- ✅ 同一轮内的样本并行预测（可配置并发数）
- ✅ 失败样本的记录和增量重预测
- ✅ 迭代历史的完整记录和可视化
- ✅ 独立的前端界面（不影响现有预测页面）

**不包含的功能**：
- ❌ 自适应迭代次数（根据收敛速度动态调整）
- ❌ 不同样本使用不同的迭代次数
- ❌ 迭代过程中的人工干预（修改中间预测值）
- ❌ 基于强化学习的迭代策略优化

### 1.5 使用场景

**场景1：高精度预测需求**
- 输入：100个新型钛合金样本
- 配置：最大迭代5次，收敛阈值1%
- 预期：大部分样本在3-4次迭代后收敛，最终预测误差降低20-30%

**场景2：快速探索**
- 输入：500个候选材料
- 配置：最大迭代3次，收敛阈值2%，并发数10
- 预期：在合理时间内完成预测，识别出收敛快的高置信度样本

**场景3：失败恢复**
- 场景：第2轮迭代时，由于 Gemini API 速率限制，50个样本失败
- 操作：系统保存前2轮的成功结果，用户稍后点击"重试失败样本"
- 预期：仅重新预测失败的50个样本，不影响已成功的样本

### 1.6 与现有系统的集成

**完全保留现有功能**：
- 现有的单次预测流程（`UNIFIED_PROTOCOL`）完全不受影响
- 所有现有 API 和前端页面保持原样
- 迭代预测作为新的、独立的功能模块

**新增独立功能**：
- 新增前端页面：`/iterative-prediction`
- 新增后端服务：`IterativePredictionService`
- 新增数据库字段：`Task.enable_iteration`, `Task.iteration_history` 等
- 新增 API 端点：`/api/iterative-prediction/start` 等

**复用现有基础设施**：
- LLM 调用通过 `llm_config_loader.get_llm()` 统一管理
- 失败重试复用 `continue_from_task_id` 机制
- 任务管理复用 `TaskManager` 服务
- 数据存储复用现有的 `results/` 目录结构

