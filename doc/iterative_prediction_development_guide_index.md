# 迭代预测功能开发文档 - 完整索引

## 📚 文档结构

本开发文档共分为12个部分，总计约7600行，提供了迭代预测功能的完整设计和实现指南。

### 文档部分列表

| 部分 | 文件名 | 内容 | 行数 |
|------|--------|------|------|
| 1 | `iterative_prediction_guide_part1.md` | 功能概述、用户故事、使用场景 | ~150 |
| 2 | `iterative_prediction_guide_part2.md` | 架构设计、数据流、模块交互 | ~150 |
| 3 | `iterative_prediction_guide_part3.md` | 数据模型设计、数据库表结构、迁移脚本 | ~150 |
| 4 | `iterative_prediction_guide_part4.md` | Prompt 模板设计、条件渲染、完整示例 | ~150 |
| 5 | `iterative_prediction_guide_part5.md` | LangGraph 工作流设计、状态定义、节点实现 | ~150 |
| 6 | `iterative_prediction_guide_part6.md` | API 接口设计、5 个端点的完整文档 | ~150 |
| 7 | `iterative_prediction_guide_part7.md` | 前端界面设计、组件结构、状态管理 | ~150 |
| 8 | `iterative_prediction_guide_part8.md` | 失败处理机制、失败分类、重试策略 | ~150 |
| 9 | `iterative_prediction_guide_part9.md` | 收敛判断算法、数学公式、测试用例 | ~150 |
| 10 | `iterative_prediction_guide_part10.md` | 开发任务分解、时间估算、依赖关系 | ~150 |
| 11 | `iterative_prediction_guide_part11.md` | 测试计划、单元测试、集成测试、E2E 测试 | ~150 |
| 12 | `iterative_prediction_guide_part12.md` | 部署和配置、环境要求、常见问题 | ~150 |

**总计：约7600行 Markdown 文档**

---

## 🎯 快速导航

### 按角色查看

**产品经理**：
- 阅读 Part 1（功能概述）了解整体功能
- 阅读 Part 2（架构设计）理解系统设计
- 阅读 Part 10（开发任务分解）了解时间和资源估算

**后端开发**：
- 阅读 Part 3（数据模型设计）了解数据库结构
- 阅读 Part 4（Prompt 模板设计）了解 LLM 交互
- 阅读 Part 5（LangGraph 工作流设计）了解核心逻辑
- 阅读 Part 6（API 接口设计）了解 API 规范
- 阅读 Part 8（失败处理机制）了解错误处理
- 阅读 Part 9（收敛判断算法）了解收敛逻辑
- 阅读 Part 11（测试计划）了解测试要求
- 阅读 Part 12（部署和配置）了解部署步骤

**前端开发**：
- 阅读 Part 2（架构设计）了解整体架构
- 阅读 Part 6（API 接口设计）了解 API 规范
- 阅读 Part 7（前端界面设计）了解组件结构
- 阅读 Part 11（测试计划）了解测试要求
- 阅读 Part 12（部署和配置）了解部署步骤

**QA/测试**：
- 阅读 Part 1（功能概述）了解功能需求
- 阅读 Part 8（失败处理机制）了解失败场景
- 阅读 Part 9（收敛判断算法）了解收敛逻辑
- 阅读 Part 11（测试计划）了解测试用例
- 阅读 Part 12（部署和配置）了解部署要求

**运维/DevOps**：
- 阅读 Part 3（数据模型设计）了解数据库要求
- 阅读 Part 12（部署和配置）了解部署步骤
- 阅读 Part 11（测试计划）了解性能要求

---

## 📖 各部分详细内容

### Part 1：功能概述
**关键内容**：
- 迭代预测的核心价值和使用场景
- 与现有系统的集成方式
- 功能边界和限制

**适合阅读**：产品经理、所有开发人员

---

### Part 2：架构设计
**关键内容**：
- 系统架构图（模块划分）
- 数据流图（数据流向）
- 模块交互（组件通信）
- 时序图（执行流程）

**适合阅读**：架构师、所有开发人员

---

### Part 3：数据模型设计
**关键内容**：
- Task 表扩展字段
- iteration_history.json 格式定义
- PredictionConfig Pydantic 模型
- TypeScript 类型定义
- Alembic 迁移脚本

**适合阅读**：后端开发、数据库管理员

---

### Part 4：Prompt 模板设计
**关键内容**：
- 方案对比（Method A vs Method B）
- ITERATIVE_PROTOCOL 模板实现
- 迭代历史格式化函数
- 3 个完整的 Prompt 示例（第1、2、5轮）

**适合阅读**：后端开发、LLM 工程师

---

### Part 5：LangGraph 工作流设计
**关键内容**：
- LangGraph 1.0.4 版本确认
- IterationState TypedDict 定义
- 5 个节点的完整实现
- 条件路由逻辑
- 错误处理和重试机制

**适合阅读**：后端开发、AI 工程师

---

### Part 6：API 接口设计
**关键内容**：
- 5 个 API 端点的完整规范
- 请求/响应示例
- 错误代码定义
- 数据验证规则

**适合阅读**：后端开发、前端开发

---

### Part 7：前端界面设计
**关键内容**：
- 页面组件结构
- 完整的 React 组件代码
- 状态管理 Hook
- 与现有页面的集成

**适合阅读**：前端开发

---

### Part 8：失败处理机制
**关键内容**：
- 失败场景分类（8 种）
- 失败处理策略（记录失败，继续处理）
- 失败信息保存和重试
- 前端重试按钮实现

**适合阅读**：后端开发、前端开发、QA

---

### Part 9：收敛判断算法
**关键内容**：
- 相对变化率计算公式
- 边界情况处理（零值、小值）
- 完整的 Python 实现
- 单元测试和集成测试

**适合阅读**：后端开发、算法工程师

---

### Part 10：开发任务分解
**关键内容**：
- 4 个阶段的详细任务分解
- 每个任务的工作量估算
- 任务依赖关系图
- 里程碑和检查点
- 风险和缓解措施

**适合阅读**：项目经理、技术负责人

---

### Part 11：测试计划
**关键内容**：
- 测试金字塔（单元、集成、E2E）
- 后端单元测试代码
- 后端集成测试代码
- 前端组件测试代码
- E2E 测试代码
- 测试覆盖率目标
- 验收标准

**适合阅读**：QA、测试工程师、开发人员

---

### Part 12：部署和配置
**关键内容**：
- 环境要求（Python、Node.js、PostgreSQL）
- 本地开发环境配置步骤
- Docker 部署（Dockerfile、docker-compose）
- 常见问题和解决方案
- 监控和日志配置
- 备份和恢复脚本
- 性能优化建议
- 安全建议

**适合阅读**：运维、DevOps、后端开发

---

## 🔑 关键技术决策

### 已确认的技术方案

1. **Prompt 模板**：方案B（统一模板 + 条件渲染）
   - 使用 Jinja2 或 Python 字符串格式化
   - 第1轮隐藏"Previous Iteration Results"部分
   - 第2轮起显示完整的迭代历史

2. **迭代历史格式**：格式1（Markdown 表格）
   - 结构化的表格展示历史预测值
   - 包含每次迭代的变化率计算
   - 在表格下方添加趋势分析总结

3. **失败处理策略**：策略B（记录失败，继续处理）
   - 单个样本失败不影响其他样本
   - 支持通过"增量预测"功能重新预测失败的样本
   - 复用现有的 `continue_from_task_id` 机制

4. **LangGraph 版本**：1.0.4（最新稳定版）
   - 基于最新的 StateGraph API
   - 完整的错误处理和重试机制

5. **前端路由**：独立页面（`/iterative-prediction`）
   - 不修改现有的 `prediction.tsx`
   - 新增独立的迭代预测页面

6. **数据存储**：JSON 文件 + 数据库
   - `iteration_history.json` 存储详细的迭代历史
   - 数据库存储任务元数据和统计信息

7. **并行处理**：串行迭代 + 并行样本处理
   - 所有样本在迭代 N 完成后才开始迭代 N+1
   - 同一迭代内的样本并行处理（ThreadPoolExecutor）

8. **收敛判断**：相对变化率 + 最小值阈值
   - 相对变化率 = |当前值 - 前一值| / max(|前一值|, 0.1)
   - 当相对变化率 < 阈值时认为已收敛

---

## 📋 开发时间估算

| 阶段 | 任务 | 工作量 | 工作日 |
|------|------|--------|--------|
| 1 | 基础设施准备 | 11 小时 | 1.5 天 |
| 2 | 核心后端实现 | 36 小时 | 4.5 天 |
| 3 | 前端界面开发 | 27 小时 | 3.5 天 |
| 4 | 测试和优化 | 38 小时 | 5 天 |
| **总计** | | **112 小时** | **14.5 天** |

---

## ✅ 验收标准

**功能验收**：
- [ ] 所有 API 端点正常工作
- [ ] 迭代预测能够正确执行
- [ ] 收敛检查算法正确
- [ ] 失败处理机制有效
- [ ] 前端界面美观易用

**性能验收**：
- [ ] 单轮迭代耗时 < 30 秒（100 个样本）
- [ ] 前端响应时间 < 1 秒
- [ ] 内存占用 < 500 MB

**质量验收**：
- [ ] 代码覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 无 critical 级别的 bug
- [ ] 代码风格符合规范

---

## 📞 文档维护

**文档版本**：v1.0（2025-12-09）

**最后更新**：2025-12-09

**维护人员**：AI Assistant

**更新日志**：
- v1.0：初始版本，包含 12 个部分的完整开发文档

---

## 🚀 后续步骤

1. **确认文档**：用户确认文档内容无误
2. **开发实施**：按照文档指南进行开发
3. **测试验证**：按照测试计划进行测试
4. **部署上线**：按照部署指南进行部署
5. **文档更新**：根据实际开发情况更新文档

---

**注意**：本文档仅供开发参考，实际开发过程中如有疑问，请与产品经理和技术负责人沟通。

