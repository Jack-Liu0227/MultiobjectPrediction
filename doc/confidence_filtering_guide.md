# 置信度筛选功能使用指南

## 概述

系统现在支持按置信度级别筛选和分析预测结果。每个预测样本都会被分配一个置信度标签：
- **high**（高）：高置信度预测
- **medium**（中）：中等置信度预测
- **low**（低）：低置信度预测
- **None**（未知）：无法确定置信度的预测

## 功能 1：预测结果页面 - 按置信度分组的评估指标

### 位置
在单个任务的预测结果页面（`/results/[id]`）的 **"评估指标"（Metrics）** 标签页中。

### 功能说明
- 默认显示所有样本的总体评估指标（R²、RMSE、MAE、MAPE）
- 可以通过置信度筛选器切换查看不同置信度组的指标：
  - **总体**：所有样本的指标
  - **高置信度**：仅高置信度样本的指标
  - **中置信度**：仅中等置信度样本的指标
  - **低置信度**：仅低置信度样本的指标

### 使用步骤
1. 打开任务的预测结果页面
2. 点击 **"评估指标"** 标签页
3. 在页面顶部找到置信度筛选器（显示各置信度级别的样本数量）
4. 点击不同的置信度按钮（总体/高/中/低）查看对应的评估指标
5. 可以导出当前选择的置信度级别的指标数据（CSV/Excel/HTML）

### 示例场景
- **场景 1**：查看高置信度样本的预测准确性
  - 选择"高置信度"筛选器
  - 查看 R² Score 是否显著高于总体水平
  
- **场景 2**：分析低置信度样本的误差
  - 选择"低置信度"筛选器
  - 查看 RMSE 和 MAE 是否显著高于总体水平
  - 导出低置信度样本数据进行进一步分析

## 功能 2：任务对比页面 - 按置信度筛选对比结果

### 位置
在任务对比页面（`/task-comparison`）的对比结果展示区域。

### 功能说明
- 默认显示所有样本的对比结果
- 可以通过置信度筛选器筛选特定置信度级别的样本进行对比
- 筛选后的结果会影响：
  - 一致性分布图（Consistency Distribution）
  - 散点图（Scatter Plots）
  - 详细统计表（Detailed Statistics）

### 使用步骤
1. 在任务对比页面选择至少 2 个任务
2. 选择要对比的目标属性
3. 点击 **"开始对比"** 按钮
4. 在对比结果区域顶部找到置信度筛选器
5. 点击不同的置信度按钮查看对应样本的对比结果
6. 所有图表和统计数据会自动更新以反映筛选后的结果

### 示例场景
- **场景 1**：对比高置信度样本的一致性
  - 选择"高置信度"筛选器
  - 查看不同任务在高置信度样本上的预测一致性
  - 分析是否高置信度样本的一致性更高
  
- **场景 2**：分析低置信度样本的差异
  - 选择"低置信度"筛选器
  - 查看不同任务在低置信度样本上的预测差异
  - 识别哪些任务在低置信度样本上表现更好

## 技术实现

### 后端修改
1. **`backend/services/task_comparison_service.py`**
   - 修改 `load_task_predictions` 方法，从 `process_details.json` 加载 confidence 信息
   - 修改 `_get_multi_target_sample_details` 方法，在 sample_details 中包含 confidence 字段

### 前端修改
1. **`frontend/lib/metricsCalculator.ts`**（新文件）
   - 提供 `calculateMetricsByConfidence` 函数，按置信度分组计算指标
   - 提供 `getMetricsForConfidence` 函数，获取特定置信度级别的指标

2. **`frontend/pages/results/[id].tsx`**
   - 添加 `metricsConfidenceFilter` 状态管理
   - 在加载结果时计算按置信度分组的指标
   - 在评估指标标签页添加置信度筛选器
   - 更新导出功能以包含置信度级别信息

3. **`frontend/pages/task-comparison.tsx`**
   - 已有 `useConfidenceFilter` hook 和 `ConfidenceFilter` 组件
   - 置信度筛选器已集成到对比结果展示中
   - 所有图表和统计数据自动响应筛选器变化

## 数据流

```
后端预测 → process_details.json (包含 confidence)
         ↓
后端加载 → predictions.csv + confidence 列
         ↓
前端接收 → 按 confidence 分组计算指标
         ↓
前端展示 → 置信度筛选器 + 分组指标
```

## 注意事项

1. **置信度来源**：置信度由 LLM 在预测时生成，存储在 `process_details.json` 中
2. **缺失处理**：如果某个样本没有置信度信息，会被标记为 `None`
3. **样本数量**：筛选后的样本数量会显示在筛选器按钮上
4. **空数据处理**：如果某个置信度级别没有样本，对应的指标会显示为 `-` 或不可用
5. **导出功能**：导出的数据会包含当前选择的置信度级别信息

## 未来扩展

可能的扩展功能：
- 支持自定义置信度阈值
- 添加置信度分布可视化图表
- 支持多个置信度级别的同时对比
- 添加置信度校准分析功能

