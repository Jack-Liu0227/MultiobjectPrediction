<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç›®æ ‡ææ–™æ€§èƒ½é¢„æµ‹ç³»ç»Ÿ - æ¶æ„å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .diagram-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: none;
        }
        
        .diagram-container.active {
            display: block;
        }
        
        .diagram-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            line-height: 1.8;
        }
        
        .description h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .diagram-container {
                padding: 15px;
            }
            
            .tab-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ å¤šç›®æ ‡ææ–™æ€§èƒ½é¢„æµ‹ç³»ç»Ÿ</h1>
            <p>é¡¹ç›®æ¶æ„å¯è§†åŒ–</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="showDiagram('architecture')">ç³»ç»Ÿæ¶æ„å›¾</button>
            <button class="tab-button" onclick="showDiagram('flow')">é¢„æµ‹æµç¨‹æ—¶åºå›¾</button>
        </div>
        
        <div id="architecture" class="diagram-container active">
            <h2 class="diagram-title">ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾</h2>
            <div class="mermaid">
graph TB
    subgraph Frontend["å‰ç«¯å±‚ (Next.js + React)"]
        UI1[æ•°æ®ä¸Šä¼ é¡µé¢<br/>datasets.tsx]
        UI2[é¢„æµ‹é…ç½®é¡µé¢<br/>prediction.tsx]
        UI3["ç»“æœå±•ç¤ºé¡µé¢<br/>results/[id].tsx"]
        UI4[ä»»åŠ¡ç®¡ç†é¡µé¢<br/>tasks.tsx]
        
        API_CLIENT[API å®¢æˆ·ç«¯<br/>lib/api.ts]
        
        UI1 --> API_CLIENT
        UI2 --> API_CLIENT
        UI3 --> API_CLIENT
        UI4 --> API_CLIENT
    end
    
    subgraph Backend["åç«¯å±‚ (FastAPI)"]
        subgraph API_Routes["API è·¯ç”±å±‚"]
            UPLOAD_API[Upload API<br/>æ–‡ä»¶ä¸Šä¼ ]
            PRED_API[Prediction API<br/>é¢„æµ‹ä»»åŠ¡]
            RESULT_API[Results API<br/>ç»“æœæŸ¥è¯¢]
            TASK_API[Tasks API<br/>ä»»åŠ¡ç®¡ç†]
            LLM_API[LLM Config API<br/>æ¨¡å‹é…ç½®]
        end

        subgraph Services["ä¸šåŠ¡é€»è¾‘å±‚"]
            RAG_SERVICE[RAG é¢„æµ‹æœåŠ¡<br/>rag_prediction_service]
            RAG_ENGINE[RAG å¼•æ“<br/>simple_rag_engine]
            TASK_MGR[ä»»åŠ¡ç®¡ç†å™¨<br/>task_manager]
            PARETO[Pareto åˆ†æå™¨<br/>pareto_analyzer]
            PROMPT[æç¤ºè¯æ„å»ºå™¨<br/>prompt_builder]
            LLM_LOADER[LLM é…ç½®åŠ è½½å™¨<br/>llm_config_loader]
            FILE_HANDLER[æ–‡ä»¶å¤„ç†å™¨<br/>file_handler]
        end

        subgraph Database["æ•°æ®è®¿é—®å±‚"]
            DATASET_DB[(æ•°æ®é›†æ•°æ®åº“<br/>dataset_db)]
            TASK_DB[(ä»»åŠ¡æ•°æ®åº“<br/>task_db)]
            SQLITE[(SQLite)]
        end
    end

    subgraph External["å¤–éƒ¨æœåŠ¡å±‚"]
        LLM_SERVICES[LLM API æœåŠ¡<br/>DeepSeek/Gemini/OpenRouter]
        EMBED_MODEL[å‘é‡åµŒå…¥æ¨¡å‹<br/>all-MiniLM-L6-v2]
        FILE_STORAGE[æ–‡ä»¶å­˜å‚¨<br/>uploads/results/cache]
    end

    subgraph Config["é…ç½®å±‚"]
        ENV_FILE[.env<br/>ç¯å¢ƒå˜é‡]
        LLM_CONFIG[llm_models.json<br/>æ¨¡å‹é…ç½®]
    end

    API_CLIENT -->|HTTP/REST| UPLOAD_API
    API_CLIENT -->|HTTP/REST| PRED_API
    API_CLIENT -->|HTTP/REST| RESULT_API
    API_CLIENT -->|HTTP/REST| TASK_API
    API_CLIENT -->|HTTP/REST| LLM_API

    UPLOAD_API --> FILE_HANDLER
    PRED_API --> RAG_SERVICE
    RESULT_API --> RAG_SERVICE
    TASK_API --> TASK_MGR
    LLM_API --> LLM_LOADER

    RAG_SERVICE --> RAG_ENGINE
    RAG_SERVICE --> TASK_MGR
    RAG_SERVICE --> PARETO
    RAG_ENGINE --> PROMPT
    RAG_ENGINE --> LLM_LOADER

    RAG_SERVICE --> DATASET_DB
    TASK_MGR --> TASK_DB
    DATASET_DB --> SQLITE
    TASK_DB --> SQLITE

    RAG_ENGINE --> LLM_SERVICES
    RAG_ENGINE --> EMBED_MODEL
    FILE_HANDLER --> FILE_STORAGE
    RAG_SERVICE --> FILE_STORAGE

    ENV_FILE -.->|åŠ è½½| LLM_LOADER
    LLM_CONFIG -.->|è¯»å–| LLM_LOADER

    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef database fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef external fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef config fill:#fff9c4,stroke:#f57f17,stroke-width:2px

    class UI1,UI2,UI3,UI4,API_CLIENT frontend
    class UPLOAD_API,PRED_API,RESULT_API,TASK_API,LLM_API backend
    class RAG_SERVICE,RAG_ENGINE,TASK_MGR,PARETO,PROMPT,LLM_LOADER,FILE_HANDLER service
    class DATASET_DB,TASK_DB,SQLITE database
    class LLM_SERVICES,EMBED_MODEL,FILE_STORAGE external
    class ENV_FILE,LLM_CONFIG config
            </div>
            <div class="description">
                <h3>ğŸ“ è¯´æ˜</h3>
                <p>æœ¬å›¾å±•ç¤ºäº†ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ï¼ŒåŒ…æ‹¬ï¼š</p>
                <ul>
                    <li><strong>å‰ç«¯å±‚</strong>ï¼šåŸºäº Next.js å’Œ React çš„ç”¨æˆ·ç•Œé¢</li>
                    <li><strong>åç«¯å±‚</strong>ï¼šFastAPI å®ç°çš„ API è·¯ç”±å’Œä¸šåŠ¡é€»è¾‘</li>
                    <li><strong>æ•°æ®è®¿é—®å±‚</strong>ï¼šSQLite æ•°æ®åº“ç®¡ç†</li>
                    <li><strong>å¤–éƒ¨æœåŠ¡å±‚</strong>ï¼šLLM API å’Œå‘é‡åµŒå…¥æ¨¡å‹</li>
                    <li><strong>é…ç½®å±‚</strong>ï¼šç¯å¢ƒå˜é‡å’Œæ¨¡å‹é…ç½®</li>
                </ul>
            </div>
        </div>

        <div id="flow" class="diagram-container">
            <h2 class="diagram-title">ğŸ”„ é¢„æµ‹æµç¨‹æ—¶åºå›¾</h2>
            <div class="mermaid">
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯ç•Œé¢
    participant API as API è·¯ç”±
    participant RAGService as RAG é¢„æµ‹æœåŠ¡
    participant RAGEngine as RAG å¼•æ“
    participant TaskMgr as ä»»åŠ¡ç®¡ç†å™¨
    participant DB as æ•°æ®åº“
    participant LLM as LLM API
    participant Embed as å‘é‡æ¨¡å‹
    participant Pareto as Pareto åˆ†æå™¨

    User->>Frontend: 1. ä¸Šä¼  CSV æ•°æ®æ–‡ä»¶
    Frontend->>API: POST /api/upload
    API->>DB: ä¿å­˜æ–‡ä»¶ä¿¡æ¯
    DB-->>API: è¿”å›æ–‡ä»¶ ID
    API-->>Frontend: è¿”å›ä¸Šä¼ æˆåŠŸ
    Frontend-->>User: æ˜¾ç¤ºåˆ—é€‰æ‹©ç•Œé¢

    User->>Frontend: 2. é€‰æ‹©åˆ—å’Œé…ç½®å‚æ•°
    Note over User,Frontend: ç»„æˆåˆ—ã€çƒ­å¤„ç†åˆ—ã€ç›®æ ‡åˆ—<br/>è®­ç»ƒæ¯”ä¾‹ã€RAG å‚æ•°ã€æ¨¡å‹é€‰æ‹©

    User->>Frontend: 3. ç‚¹å‡»"å¼€å§‹é¢„æµ‹"
    Frontend->>API: POST /api/prediction/start
    API->>RAGService: åˆ›å»ºé¢„æµ‹ä»»åŠ¡
    RAGService->>TaskMgr: æ³¨å†Œä»»åŠ¡
    TaskMgr->>DB: ä¿å­˜ä»»åŠ¡çŠ¶æ€ (pending)
    RAGService-->>API: è¿”å› task_id
    API-->>Frontend: è¿”å› task_id
    Frontend-->>User: æ˜¾ç¤ºä»»åŠ¡è¿›åº¦ç•Œé¢

    Note over RAGService,Pareto: åå°å¼‚æ­¥æ‰§è¡Œ

    RAGService->>TaskMgr: æ›´æ–°çŠ¶æ€ (running)
    RAGService->>DB: è¯»å–æ•°æ®æ–‡ä»¶
    RAGService->>RAGService: æ•°æ®åˆ’åˆ† (è®­ç»ƒé›†/æµ‹è¯•é›†)

    RAGService->>Embed: åµŒå…¥è®­ç»ƒé›†æ ·æœ¬
    Embed-->>RAGService: è¿”å›è®­ç»ƒé›†å‘é‡

    loop å¯¹æ¯ä¸ªæµ‹è¯•æ ·æœ¬
        RAGService->>Embed: åµŒå…¥æµ‹è¯•æ ·æœ¬
        Embed-->>RAGService: è¿”å›æµ‹è¯•æ ·æœ¬å‘é‡

        RAGService->>RAGEngine: æ£€ç´¢ç›¸ä¼¼æ ·æœ¬
        RAGEngine->>RAGEngine: è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
        RAGEngine-->>RAGService: è¿”å› Top-K ç›¸ä¼¼æ ·æœ¬

        RAGService->>RAGEngine: ç”Ÿæˆé¢„æµ‹
        RAGEngine->>RAGEngine: æ„å»ºæç¤ºè¯
        RAGEngine->>LLM: è°ƒç”¨ LLM API
        LLM-->>RAGEngine: è¿”å›é¢„æµ‹ç»“æœ
        RAGEngine->>RAGEngine: è§£æé¢„æµ‹å€¼
        RAGEngine-->>RAGService: è¿”å›å¤šç›®æ ‡é¢„æµ‹

        RAGService->>DB: ä¿å­˜é¢„æµ‹ç»“æœ
        RAGService->>TaskMgr: æ›´æ–°è¿›åº¦
    end

    RAGService->>RAGService: è®¡ç®—è¯„ä¼°æŒ‡æ ‡<br/>(RÂ², RMSE, MAE, MAPE)
    RAGService->>Pareto: Pareto å‰æ²¿åˆ†æ
    Pareto->>Pareto: è¯†åˆ« Pareto æœ€ä¼˜è§£
    Pareto->>Pareto: è®¡ç®—ä¼˜åŒ–æŒ‡æ ‡<br/>(Hypervolume, Spacing, Spread)
    Pareto-->>RAGService: è¿”å›åˆ†æç»“æœ

    RAGService->>DB: ä¿å­˜æœ€ç»ˆç»“æœ
    RAGService->>TaskMgr: æ›´æ–°çŠ¶æ€ (completed)

    loop è½®è¯¢ä»»åŠ¡çŠ¶æ€
        Frontend->>API: GET /api/tasks/{task_id}
        API->>TaskMgr: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        TaskMgr->>DB: è¯»å–ä»»åŠ¡ä¿¡æ¯
        DB-->>TaskMgr: è¿”å›ä»»åŠ¡æ•°æ®
        TaskMgr-->>API: è¿”å›ä»»åŠ¡çŠ¶æ€
        API-->>Frontend: è¿”å›çŠ¶æ€å’Œè¿›åº¦
        Frontend-->>User: æ›´æ–°è¿›åº¦æ¡
    end

    Frontend->>API: GET /api/results/{task_id}
    API->>RAGService: è·å–é¢„æµ‹ç»“æœ
    RAGService->>DB: è¯»å–ç»“æœæ•°æ®
    DB-->>RAGService: è¿”å›å®Œæ•´ç»“æœ
    RAGService-->>API: è¿”å›ç»“æœ JSON
    API-->>Frontend: è¿”å›ç»“æœæ•°æ®

    Frontend->>Frontend: æ¸²æŸ“ç»“æœè¡¨æ ¼
    Frontend->>Frontend: ç»˜åˆ¶å¯è§†åŒ–å›¾è¡¨
    Frontend-->>User: å±•ç¤ºé¢„æµ‹ç»“æœå’Œåˆ†æ

    User->>Frontend: 4. ä¸‹è½½ç»“æœ CSV
    Frontend->>API: GET /api/results/{task_id}/download
    API->>RAGService: ç”Ÿæˆ CSV æ–‡ä»¶
    RAGService-->>API: è¿”å› CSV æ–‡ä»¶
    API-->>Frontend: è¿”å›æ–‡ä»¶æµ
    Frontend-->>User: ä¸‹è½½å®Œæˆ
            </div>
            <div class="description">
                <h3>ğŸ“ è¯´æ˜</h3>
                <p>æœ¬å›¾å±•ç¤ºäº†å®Œæ•´çš„é¢„æµ‹æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p>
                <ol>
                    <li><strong>æ•°æ®ä¸Šä¼ </strong>ï¼šç”¨æˆ·ä¸Šä¼  CSV æ–‡ä»¶</li>
                    <li><strong>é…ç½®å‚æ•°</strong>ï¼šé€‰æ‹©åˆ—å’Œé…ç½® RAG/LLM å‚æ•°</li>
                    <li><strong>å¼‚æ­¥é¢„æµ‹</strong>ï¼šåå°æ‰§è¡Œ RAG æ£€ç´¢å’Œ LLM é¢„æµ‹</li>
                    <li><strong>Pareto åˆ†æ</strong>ï¼šå¤šç›®æ ‡ä¼˜åŒ–åˆ†æ</li>
                    <li><strong>ç»“æœå±•ç¤º</strong>ï¼šå¯è§†åŒ–å±•ç¤ºé¢„æµ‹ç»“æœ</li>
                </ol>
            </div>
        </div>

        <div class="footer">
            <p>å¤šç›®æ ‡ææ–™æ€§èƒ½é¢„æµ‹ç³»ç»Ÿ | ç‰ˆæœ¬ 1.0 | 2025-12-06</p>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });

        function showDiagram(diagramId) {
            // éšè—æ‰€æœ‰å›¾è¡¨
            document.querySelectorAll('.diagram-container').forEach(container => {
                container.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„å›¾è¡¨
            document.getElementById(diagramId).classList.add('active');

            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            event.target.classList.add('active');
        }
    </script>
</body>
</html>

