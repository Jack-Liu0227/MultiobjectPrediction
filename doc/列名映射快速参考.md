# 列名映射快速参考

## 一句话总结

**列名映射配置存储在提示词模板中，由 `PromptBuilder._apply_column_name_mapping()` 统一应用，确保预览和预测结果一致。**

---

## 核心文件（3 个）

| 文件 | 职责 | 关键方法/字段 |
|------|------|--------------|
| `backend/services/sample_text_builder.py` | 使用**原始列名**构建样本文本 | `build_sample_text()` |
| `backend/services/prompt_builder.py` | **应用列名映射**，构建最终提示词 | `_apply_column_name_mapping()` |
| `storage/prompt_templates/*.json` | 存储列名映射配置 | `column_name_mapping` 字段 |

---

## 数据流（3 步）

```
1. SampleTextBuilder
   ↓ 使用原始列名
   Processing_Description: value

2. PromptBuilder._apply_column_name_mapping()
   ↓ 应用映射
   Heat treatment method: value

3. 最终 Prompt
   ↓ 保存到文件
   storage/results/{task_id}/inputs/sample_*.txt
```

---

## 关键代码位置

### 1. 映射应用逻辑

**文件**：`backend/services/prompt_builder.py`  
**方法**：`_apply_column_name_mapping()` (第 150-167 行)

```python
def _apply_column_name_mapping(self, text: str) -> str:
    result = text
    for old_name, new_name in self.column_name_mapping.items():
        result = result.replace(f"{old_name}:", f"{new_name}:")
    return result
```

### 2. 映射应用时机

**文件**：`backend/services/prompt_builder.py`  
**方法**：`build_prompt()` (第 169 行)

```python
# 测试样本映射 (第 207 行)
mapped_test_sample = self._apply_column_name_mapping(test_sample)

# 参考样本映射 (第 466 行)
mapped_sample_text = self._apply_column_name_mapping(sample_text)
```

### 3. 映射配置传递

**预览 API** (`backend/api/prompt_templates.py` 第 121 行):
```python
column_name_mapping = request.column_name_mapping
```

**实际预测** (`backend/services/simple_rag_engine.py` 第 217 行):
```python
column_name_mapping = custom_template["column_name_mapping"]
```

---

## 设计原则（3 条）

1. **单一职责**：`SampleTextBuilder` 只负责构建，`PromptBuilder` 只负责映射
2. **统一控制**：列名映射只在 `PromptBuilder` 中应用一次
3. **延迟映射**：在构建最终提示词时才应用，不影响 RAG 检索

---

## 常见问题

### Q: 如何修改列名映射逻辑？

**A**: 只需修改 `backend/services/prompt_builder.py` 的 `_apply_column_name_mapping()` 方法。

### Q: 为什么不在 `SampleTextBuilder` 中应用映射？

**A**: 
1. RAG 检索需要使用原始列名
2. 同一样本文本可能需要不同的映射
3. 职责分离，易于维护

### Q: 如何确保预览和预测结果一致？

**A**: 
1. 两者都使用 `PromptBuilder.build_prompt()`
2. 两者都使用 `SampleTextBuilder` 构建样本文本
3. 列名映射只在一个地方应用

---

## 调试技巧

### 1. 检查映射配置

```bash
# 查看模板文件
cat storage/prompt_templates/default_multi_target.json | grep -A 5 "column_name_mapping"
```

### 2. 检查保存的 Prompt

```bash
# 查看实际预测的 prompt
cat storage/results/{task_id}/inputs/sample_0_*.txt
```

### 3. 添加调试日志

在 `backend/services/prompt_builder.py` 第 163 行后添加：
```python
logger.info(f"映射前: {text[:100]}")
logger.info(f"映射后: {result[:100]}")
```

---

## 完整示例

### 配置
```json
{
  "column_name_mapping": {
    "Processing_Description": "Heat treatment method",
    "Aging_Treatment(K)": "Aging Temperature"
  }
}
```

### 输入
```python
row = {
    "Processing_Description": "Homogenization at 298K",
    "Aging_Treatment(K)": "1173"
}
```

### 输出

**SampleTextBuilder 输出**（原始列名）:
```
Processing_Description: Homogenization at 298K
Aging_Treatment(K): 1173
```

**PromptBuilder 输出**（映射后）:
```
Heat treatment method: Homogenization at 298K
Aging Temperature: 1173
```

---

## 修改检查清单

当修改列名映射相关代码时，确保：

- [ ] `SampleTextBuilder` 只使用原始列名
- [ ] `PromptBuilder._apply_column_name_mapping()` 正确应用映射
- [ ] 预览 API 和实际预测使用相同的映射配置
- [ ] 列名映射只应用一次（避免双重映射）
- [ ] 测试预览和预测结果是否一致

