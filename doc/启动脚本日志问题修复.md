# 启动脚本日志文件占用问题修复

## 问题描述

运行 `start_all.sh` 时出现错误：
```
./start_all.sh: line 301: /d/XJTU/ImportantFile/MuItiObject/Logs/backend.log: Device or resource busy
```

## 问题原因

1. **旧进程未清理**：之前运行的后端/前端进程可能仍在运行，占用日志文件
2. **端口占用**：8000/3000 端口被旧进程占用
3. **日志文件锁定**：日志文件被编辑器或其他进程打开，导致无法写入
4. **文件覆盖模式**：使用 `>` 覆盖模式可能导致文件锁定问题

## 解决方案

### 1. 添加进程检查和清理（第0.5步）

在启动服务前，脚本会：
- 检查并停止旧的后端进程（通过 PID 文件）
- 检查并停止旧的前端进程（通过 PID 文件）
- 检查端口 8000 和 3000 是否被占用
- 如果端口被占用，尝试停止占用进程
- 如果无法停止，提示用户手动处理并退出

### 2. 改进日志文件处理

- **备份旧日志**：将旧的日志文件重命名为 `.old` 后缀
- **创建新日志文件**：使用 `touch` 创建空日志文件
- **设置权限**：确保日志文件可写（644）
- **使用追加模式**：从 `>` 改为 `>>` 避免文件锁定
- **使用 nohup**：确保进程在后台稳定运行

### 3. 创建停止脚本

新增 `stop_all.sh` 脚本，提供以下功能：
- 通过 PID 文件停止服务
- 通过端口查找并停止进程
- 支持强制停止（kill -9）
- 清理 PID 文件

## 使用方法

### 启动服务
```bash
./start_all.sh
```

脚本会自动：
1. 检查并清理旧进程
2. 检查端口占用
3. 备份旧日志
4. 启动后端和前端服务

### 停止服务
```bash
./stop_all.sh
```

或者使用 Ctrl+C 停止 `start_all.sh`（会自动清理）

### 手动清理

如果脚本无法自动清理，可以手动执行：

```bash
# 查找占用端口的进程
lsof -i :8000
lsof -i :3000

# 停止进程
kill <PID>

# 强制停止
kill -9 <PID>

# 清理 PID 文件
rm -rf .temp/
```

## 修改内容

### start_all.sh

1. **第0.5步：进程检查和清理**（47-120行）
   - 检查并停止旧进程
   - 检查端口占用
   - 提供 `check_port()` 函数

2. **日志文件处理**（356-370行）
   - 备份旧日志文件
   - 创建新日志文件
   - 设置文件权限

3. **启动命令改进**（383行、419行）
   - 使用 `nohup` 命令
   - 使用 `>>` 追加模式

### 新增文件

- `stop_all.sh`：停止服务脚本

## 注意事项

1. **权限问题**：确保脚本有执行权限
   ```bash
   chmod +x start_all.sh stop_all.sh
   ```

2. **日志查看**：旧日志会保存为 `.old` 后缀
   ```bash
   tail -f Logs/backend.log      # 查看当前日志
   cat Logs/backend.log.old      # 查看旧日志
   ```

3. **Windows 环境**：如果在 Git Bash 或 WSL 中运行，`lsof` 命令可能不可用
   - 可以使用 `netstat` 或 `tasklist` 替代
   - 建议使用 `start_all.bat` 或 `start_all.ps1`

## 测试结果

修复后，脚本应该能够：
- ✅ 自动检测并清理旧进程
- ✅ 避免日志文件锁定问题
- ✅ 正确启动后端和前端服务
- ✅ 提供清晰的错误提示
- ✅ 支持优雅停止服务

