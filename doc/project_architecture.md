# 多目标材料性能预测系统 - 项目架构

## 系统概览

本系统是一个基于 RAG（检索增强生成）的多目标材料性能预测平台，采用前后端分离架构，支持多个性能指标的同时预测和 Pareto 前沿分析。

## 技术栈

### 前端
- **框架**: Next.js (React)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **HTTP 客户端**: Axios
- **可视化**: Plotly.js

### 后端
- **框架**: FastAPI (Python)
- **异步服务器**: Uvicorn
- **数据处理**: Pandas, NumPy
- **机器学习**: Scikit-learn
- **向量嵌入**: Sentence-Transformers
- **LLM 调用**: LiteLLM
- **深度学习**: PyTorch

### 数据存储
- **数据库**: SQLite
- **文件存储**: 本地文件系统
- **缓存**: 内存缓存

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户界面层 (Frontend)                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  数据上传页   │  │  预测配置页   │  │  结果展示页   │             │
│  │ (datasets)   │  │ (prediction) │  │  (results)   │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│         │                  │                  │                     │
│         └──────────────────┴──────────────────┘                     │
│                            │                                        │
│                    ┌───────▼────────┐                              │
│                    │  API 客户端     │                              │
│                    │  (lib/api.ts)  │                              │
│                    └───────┬────────┘                              │
└────────────────────────────┼─────────────────────────────────────────┘
                             │ HTTP/REST API
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                        API 路由层 (Backend)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ ┌────────┐ ┌──────────┐    │
│  │ Upload  │ │Prediction│ │ Results │ │ Tasks  │ │LLM Config│    │
│  │  API    │ │   API    │ │   API   │ │  API   │ │   API    │    │
│  └────┬────┘ └────┬─────┘ └────┬────┘ └───┬────┘ └────┬─────┘    │
│       │           │             │          │           │           │
│       └───────────┴─────────────┴──────────┴───────────┘           │
│                            │                                        │
└────────────────────────────┼─────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                        业务逻辑层 (Services)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │ RAG 预测服务      │  │  任务管理器       │  │ Pareto 分析器    │  │
│  │ (rag_prediction) │  │ (task_manager)   │  │(pareto_analyzer)│  │
│  └────────┬─────────┘  └────────┬─────────┘  └─────────────────┘  │
│           │                     │                                  │
│  ┌────────▼─────────┐  ┌────────▼─────────┐  ┌─────────────────┐  │
│  │  RAG 引擎        │  │  文件处理器       │  │ 提示词构建器     │  │
│  │(simple_rag_engine│  │ (file_handler)   │  │(prompt_builder) │  │
│  └────────┬─────────┘  └──────────────────┘  └─────────────────┘  │
│           │                                                         │
│  ┌────────▼─────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │ LLM 配置加载器    │  │ 样本文本构建器    │  │ 模板管理器       │  │
│  │(llm_config_loader│  │(sample_text_     │  │(prompt_template_│  │
│  │                  │  │     builder)     │  │    manager)     │  │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                        数据访问层 (Database)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐                        │
│  │  数据集数据库     │  │   任务数据库      │                        │
│  │  (dataset_db)    │  │   (task_db)      │                        │
│  └────────┬─────────┘  └────────┬─────────┘                        │
│           │                     │                                  │
│           └──────────┬──────────┘                                  │
│                      │                                             │
│              ┌───────▼────────┐                                    │
│              │  SQLite 数据库  │                                    │
│              └────────────────┘                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                        外部服务层 (External)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │  LLM API 服务     │  │  向量嵌入模型     │  │  文件存储        │  │
│  │  - DeepSeek      │  │  all-MiniLM-L6-v2│  │  - uploads/     │  │
│  │  - Gemini        │  │  (本地模型)       │  │  - results/     │  │
│  │  - OpenRouter    │  │                  │  │  - cache/       │  │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. 前端组件

#### 页面组件
- **datasets.tsx**: 数据集管理页面
- **prediction.tsx**: 预测配置和执行页面
- **results/[id].tsx**: 预测结果展示页面
- **tasks.tsx**: 任务管理页面

#### 功能组件
- **FileUpload**: 文件上传组件
- **ColumnSelector**: 列选择器
- **PredictionConfig**: 预测参数配置
- **DatasetSplitPanel**: 数据集划分面板
- **TaskProgressPanel**: 任务进度显示
- **ParetoFrontChart**: Pareto 前沿可视化
- **PredictionScatterChart**: 预测散点图

### 2. 后端 API 路由

#### 核心 API
- **/api/upload**: 数据文件上传
- **/api/prediction**: 预测任务创建和执行
- **/api/results**: 预测结果查询
- **/api/tasks**: 任务状态管理
- **/api/llm/models**: LLM 模型配置
- **/api/prompt-templates**: 提示词模板管理

### 3. 业务服务层

#### RAG 预测服务 (rag_prediction_service.py)
- 管理预测任务的完整生命周期
- 协调数据划分、向量检索、LLM 调用
- 支持增量预测和失败重试

#### RAG 引擎 (simple_rag_engine.py)
- 基于 Sentence-Transformers 的向量嵌入
- 余弦相似度检索
- 多目标预测生成

#### 任务管理器 (task_manager.py)
- 异步任务调度
- 任务状态跟踪
- 并发控制

#### Pareto 分析器 (pareto_analyzer.py)
- Pareto 前沿识别
- 多目标优化指标计算（Hypervolume, Spacing, Spread）
- 可视化数据生成

#### LLM 配置加载器 (llm_config_loader.py)
- 从配置文件加载 LLM 模型配置
- 支持环境变量替换
- 配置验证

#### 提示词构建器 (prompt_builder.py)
- 动态构建 LLM 提示词
- 支持自定义模板
- 多目标预测格式化

## 数据流程

### 预测流程

```
1. 用户上传数据
   ↓
2. 前端：选择列、配置参数
   ↓
3. 后端：创建预测任务
   ↓
4. 数据划分（训练集/测试集）
   ↓
5. 向量嵌入（Sentence-Transformers）
   ↓
6. 对每个测试样本：
   ├─ 检索相似训练样本
   ├─ 构建提示词
   ├─ 调用 LLM 生成预测
   └─ 保存预测结果
   ↓
7. 计算评估指标（R², RMSE, MAE, MAPE）
   ↓
8. Pareto 前沿分析
   ↓
9. 返回结果给前端
   ↓
10. 前端：可视化展示
```

### 配置加载流程

```
1. 应用启动
   ↓
2. 加载 .env 文件（python-dotenv）
   ↓
3. 读取 backend/config/llm_models.json
   ↓
4. 替换环境变量占位符 ${VAR_NAME}
   ↓
5. 验证配置完整性
   ↓
6. 提供给 API 和服务层使用
```

## 目录结构

```
MuItiObject/
├── frontend/                    # 前端应用
│   ├── pages/                   # Next.js 页面
│   ├── components/              # React 组件
│   ├── lib/                     # 工具库
│   ├── styles/                  # 样式文件
│   └── package.json             # 前端依赖
│
├── backend/                     # 后端应用
│   ├── api/                     # API 路由
│   ├── services/                # 业务逻辑
│   ├── database/                # 数据库模型
│   ├── models/                  # 数据模型（Pydantic）
│   ├── config/                  # 配置文件
│   ├── utils/                   # 工具函数
│   ├── main.py                  # 应用入口
│   └── requirements.txt         # 后端依赖
│
├── storage/                     # 数据存储
│   ├── uploads/                 # 上传文件
│   ├── results/                 # 预测结果
│   ├── cache/                   # 缓存数据
│   ├── tasks/                   # 任务数据
│   ├── database/                # SQLite 数据库
│   └── prompt_templates/        # 提示词模板
│
├── all-MiniLM-L6-v2/           # RAG 向量模型
│   ├── config.json
│   ├── model.safetensors
│   └── ...
│
├── doc/                         # 项目文档
│   └── project_architecture.md  # 本文档
│
├── .env                         # 环境变量（不提交）
├── .env.example                 # 环境变量示例
├── start_all.sh                 # 启动脚本（Linux/Mac）
└── README.md                    # 项目说明
```

## 关键技术实现

### 1. RAG（检索增强生成）

系统使用 RAG 技术提升预测准确性：

1. **向量嵌入**: 使用 `all-MiniLM-L6-v2` 模型将材料组成和热处理工艺转换为向量
2. **相似度检索**: 基于余弦相似度检索最相关的训练样本
3. **上下文增强**: 将检索到的样本作为上下文提供给 LLM
4. **预测生成**: LLM 基于上下文生成多目标性能预测

### 2. 多目标优化

支持同时预测 2-5 个性能指标：

- **并行预测**: 一次 LLM 调用生成所有目标的预测值
- **Pareto 分析**: 自动识别 Pareto 最优解
- **质量指标**: 计算 Hypervolume、Spacing、Spread 等指标

### 3. 环境变量管理

安全的 API 密钥管理：

- **配置模块**: `backend/config/llm_models.py` 使用 `os.getenv()` 读取环境变量
- **环境变量**: `backend/.env` 文件存储实际密钥
- **自动加载**: 配置模块启动时自动从环境变量读取
- **安全性**: `.env` 文件不提交到版本控制，无硬编码敏感信息

### 4. 异步任务处理

- **后台执行**: 预测任务在后台异步执行
- **状态跟踪**: 实时更新任务状态（pending, running, completed, failed）
- **进度报告**: 前端轮询获取任务进度
- **并发控制**: 支持多个工作线程并行处理

## 扩展性设计

### 1. 模型扩展

- 支持添加新的 LLM 模型（编辑 `llm_models.json`）
- 支持自定义提示词模板
- 支持不同的向量嵌入模型

### 2. 功能扩展

- 可添加新的评估指标
- 可扩展 Pareto 分析算法
- 可集成更多可视化图表

### 3. 性能优化

- 向量缓存机制
- 结果缓存
- 批量预测优化
- 数据库索引优化

## 安全性考虑

1. **API 密钥保护**: 使用环境变量，不在代码中硬编码
2. **文件上传限制**: 限制文件大小和类型
3. **CORS 配置**: 限制跨域访问
4. **输入验证**: 使用 Pydantic 进行数据验证
5. **错误处理**: 统一的异常处理机制

## 部署建议

### 开发环境
- 使用 `start_all.sh` 或 `start_all.bat` 快速启动
- 前端：http://localhost:3000
- 后端：http://localhost:8000

### 生产环境
- 使用 Nginx 作为反向代理
- 使用 Gunicorn 或 Uvicorn 运行后端
- 使用 PM2 管理 Node.js 进程
- 配置 HTTPS
- 使用 PostgreSQL 替代 SQLite（可选）
- 配置日志轮转
- 设置监控和告警

## 性能指标

- **并发支持**: 默认 5 个工作线程
- **文件大小**: 最大 50MB
- **响应时间**: API 响应 < 100ms（不含 LLM 调用）
- **预测速度**: 取决于 LLM API 响应速度和并发数

## 维护和监控

- **日志**: 存储在 `Logs/` 和 `storage/logs/` 目录
- **任务追踪**: 通过任务数据库追踪所有预测任务
- **错误处理**: 详细的错误日志和堆栈跟踪
- **健康检查**: API 根路径提供健康检查端点

---

**文档版本**: 1.0
**最后更新**: 2025-12-06
**维护者**: 项目开发团队

