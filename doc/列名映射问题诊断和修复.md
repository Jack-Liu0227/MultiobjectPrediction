# 列名映射问题诊断和修复指南

## 问题描述

**症状**：提示词中显示原始列名（如 `Processing_Description:`），而不是映射后的名称（如 `Heat treatment method:`）

**根本原因**：模板配置中的列名映射键名与实际数据列名不匹配

---

## 问题诊断

### 步骤 1：检查实际数据列名

查看您的数据文件，确认工艺列的实际列名：

```python
# 示例数据
{
    "Processing_Description": "Homogenization at 298K",  # ← 实际列名
    "Aging_Treatment(K)": "1173",                        # ← 实际列名
    "Al(wt%)": "5.3",
    "Co(wt%)": "21"
}
```

### 步骤 2：检查模板配置

查看模板文件 `storage/prompt_templates/default_multi_target.json`：

```bash
cat storage/prompt_templates/default_multi_target.json | grep -A 5 "column_name_mapping"
```

**错误配置示例**（不会生效）：
```json
{
  "column_name_mapping": {
    "Processing": "Heat treatment method",  // ❌ 数据中没有 "Processing" 列
    "Composition": "Composition"
  }
}
```

**正确配置示例**：
```json
{
  "column_name_mapping": {
    "Processing_Description": "Heat treatment method",  // ✅ 匹配实际列名
    "Aging_Treatment(K)": "Aging Temperature",          // ✅ 匹配实际列名
    "Composition": "Composition"
  }
}
```

### 步骤 3：运行测试脚本

```bash
cd backend
python test_column_mapping.py
```

测试脚本会：
1. 加载模板配置
2. 构建测试样本
3. 应用列名映射
4. 验证映射结果

**期望输出**：
```
✅ 列名映射测试通过！
所有列名都已正确映射。
```

---

## 修复方案

### 方案 1：手动修改模板文件（推荐）

编辑 `storage/prompt_templates/default_multi_target.json`：

```json
{
  "column_name_mapping": {
    "Processing": "Heat treatment method",
    "Processing_Description": "Heat treatment method",
    "Aging_Treatment(K)": "Aging Temperature",
    "Composition": "Composition"
  }
}
```

**注意**：
- 保留 `"Processing"` 是为了向后兼容
- 添加 `"Processing_Description"` 以匹配新的数据列名
- 添加所有需要映射的工艺列

### 方案 2：通过前端编辑器修改

1. 打开前端页面
2. 进入"提示词模板编辑器"
3. 选择"默认多目标模板"
4. 在"列名映射配置"部分添加：
   - `Processing_Description` → `Heat treatment method`
   - `Aging_Treatment(K)` → `Aging Temperature`
5. 点击"保存模板"

### 方案 3：更新默认模板定义

编辑 `backend/services/prompt_template_manager.py`：

```python
# 第 38-41 行
default_column_mapping = {
    "Processing": "Heat treatment method",
    "Processing_Description": "Heat treatment method",  # 添加这行
    "Aging_Treatment(K)": "Aging Temperature",          # 添加这行
    "Composition": "Alloy Composition"
}
```

然后删除旧的模板文件，让系统重新生成：

```bash
rm storage/prompt_templates/default_multi_target.json
rm storage/prompt_templates/default_single_target.json
```

重启后端服务，系统会自动创建新的默认模板。

---

## 验证修复

### 1. 运行测试脚本

```bash
cd backend
python test_column_mapping.py
```

### 2. 检查预览功能

在前端：
1. 进入"提示词模板编辑器"
2. 选择测试样本
3. 点击"预览提示词"
4. 检查预览结果中是否显示映射后的列名

**期望结果**：
```
**Target Material**:
Composition: Al 5.3, Co 21, Cr 21.1, Fe 26.3, Ni 26.3
Heat treatment method: the first heat treatment is Homogenization at 298K...
Aging Temperature: 1173
```

### 3. 检查实际预测

运行一次预测，然后检查保存的提示词文件：

```bash
# 找到最新的预测任务
ls -lt storage/results/

# 查看保存的提示词
cat storage/results/{task_id}/inputs/sample_0_*.txt
```

确认文件中使用了映射后的列名。

---

## 常见错误

### 错误 1：列名大小写不匹配

```json
// ❌ 错误
"processing_description": "Heat treatment method"  // 小写

// ✅ 正确（假设数据中是驼峰命名）
"Processing_Description": "Heat treatment method"
```

**解决方案**：确保映射配置中的列名与数据中的列名完全一致（包括大小写）。

### 错误 2：列名包含特殊字符

```json
// ✅ 正确
"Aging_Treatment(K)": "Aging Temperature"  // 包含括号
```

**注意**：列名中的特殊字符（如括号、空格）必须完全匹配。

### 错误 3：映射配置未保存

**症状**：在前端编辑器中修改了映射，但刷新后又恢复了。

**解决方案**：
1. 确保点击了"保存模板"按钮
2. 检查浏览器控制台是否有错误信息
3. 检查后端日志是否有保存失败的错误

### 错误 4：使用了错误的模板

**症状**：修改了模板 A，但预测时使用的是模板 B。

**解决方案**：
1. 在预测配置中确认选择了正确的模板
2. 检查 `predictionConfig.prompt_template.template_name`

---

## 调试技巧

### 1. 启用调试日志

修改后端日志级别为 `DEBUG`：

```python
# backend/main.py 或 config.py
logging.basicConfig(level=logging.DEBUG)
```

### 2. 查看映射应用日志

运行预测或预览后，查看后端日志：

```
=== 列名映射调试 ===
映射配置: {'Processing_Description': 'Heat treatment method', ...}
映射前文本（前200字符）: Composition: Al 5.3, Co 21...
✓ 应用映射: Processing_Description: → Heat treatment method:
✓ 应用映射: Aging_Treatment(K): → Aging Temperature:
映射后文本（前200字符）: Composition: Al 5.3, Co 21...
列名映射已应用: Processing_Description → Heat treatment method, Aging_Treatment(K) → Aging Temperature
```

### 3. 对比预览和实际预测

1. 在前端预览提示词，复制结果
2. 运行实际预测，查看保存的提示词文件
3. 使用 diff 工具对比两者

```bash
diff preview.txt storage/results/{task_id}/inputs/sample_0_*.txt
```

---

## 总结

### 核心要点

1. **列名必须精确匹配**：映射配置中的键名必须与数据中的列名完全一致
2. **区分大小写**：`Processing` ≠ `processing` ≠ `Processing_Description`
3. **包含特殊字符**：`Aging_Treatment(K)` 必须包含括号
4. **验证修复**：使用测试脚本和预览功能验证

### 快速修复清单

- [ ] 检查数据中的实际列名
- [ ] 更新模板配置中的 `column_name_mapping`
- [ ] 运行 `python backend/test_column_mapping.py`
- [ ] 在前端预览提示词，确认映射生效
- [ ] 运行实际预测，检查保存的提示词文件
- [ ] 确认预览和实际预测结果一致

